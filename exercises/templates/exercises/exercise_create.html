{% extends 'exercises/base.html' %}

{% block title %}Create Exercise - Practika{% endblock %}

{% block content %}
<div class="card">
    <h1>Create New Exercise</h1>
    
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="form-group">
            <label for="name">Exercise Name:</label>
            <input type="text" id="name" name="name" required>
        </div>
        
        <div class="form-group">
            <label for="description">Description:</label>
            <textarea id="description" name="description" rows="3"></textarea>
        </div>
        
        <div class="form-group">
            <label for="video">Video:</label>
            <input type="file" id="video" name="video" accept="video/*" style="display: none;">
            <div class="video-options">
                <button type="button" id="upload-btn" class="btn btn-secondary">üìÅ Upload Video</button>
                <button type="button" id="record-btn" class="btn btn-primary">üé• Record Video</button>
            </div>
            <div id="video-preview" style="display: none;">
                <p>‚úÖ Video ready: <span id="video-name"></span></p>
                <button type="button" id="change-video" class="btn btn-sm btn-outline">Change Video</button>
            </div>
            <div id="webcam-container" style="display: none;">
                <video id="webcam-preview" autoplay muted playsinline style="width: 100%; max-width: 400px; border-radius: 8px;"></video>
                <div class="webcam-controls" style="margin-top: 10px;">
                    <button type="button" id="flip-camera" class="btn btn-sm btn-secondary" style="display: none;">üîÑ Flip</button>
                    <button type="button" id="record-video" class="btn btn-danger" style="display: none;">üî¥ Start Recording</button>
                    <button type="button" id="stop-recording" class="btn btn-warning" style="display: none;">‚èπÔ∏è Stop Recording</button>
                    <button type="button" id="cancel-recording" class="btn btn-sm btn-outline">Cancel</button>
                </div>
                <div id="recording-status" style="display: none;">
                    <p>üî¥ Recording... <span id="recording-time">00:00</span></p>
                </div>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="submit-btn">Create Exercise</button>
            <a href="{% url 'exercises:exercise_list' %}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
// Simplified video recording functionality - Version 2.0 (Fixed)
document.addEventListener('DOMContentLoaded', function() {
    console.log('Practika video recording v2.0 loaded - Fixed version');
    const uploadBtn = document.getElementById('upload-btn');
    const recordBtn = document.getElementById('record-btn');
    const videoInput = document.getElementById('video');
    const videoPreview = document.getElementById('video-preview');
    const videoName = document.getElementById('video-name');
    const webcamContainer = document.getElementById('webcam-container');
    const flipCameraBtn = document.getElementById('flip-camera');
    const recordVideoBtn = document.getElementById('record-video');
    const stopBtn = document.getElementById('stop-recording');
    const cancelBtn = document.getElementById('cancel-recording');
    const changeVideoBtn = document.getElementById('change-video');
    const webcamPreview = document.getElementById('webcam-preview');
    const recordingStatus = document.getElementById('recording-status');
    const recordingTime = document.getElementById('recording-time');
    
    let mediaRecorder;
    let recordedChunks = [];
    let recordingStartTime;
    let recordingInterval;
    let currentStream = null;
    let currentFacingMode = 'user'; // Start with front camera
    
    // Upload button click
    uploadBtn.addEventListener('click', function() {
        videoInput.click();
    });
    
    // Change video button click
    changeVideoBtn.addEventListener('click', function() {
        videoPreview.style.display = 'none';
        videoInput.value = '';
    });
    
    // File input change
    videoInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const file = this.files[0];
            videoName.textContent = file.name;
            videoPreview.style.display = 'block';
            webcamContainer.style.display = 'none';
            // Clear any globally stored recorded file
            window.recordedVideoFile = null;
        }
    });
    
    // Record button click - start camera immediately
    recordBtn.addEventListener('click', async function() {
        webcamContainer.style.display = 'block';
        videoPreview.style.display = 'none';
        
        try {
            await startCamera();
        } catch (err) {
            console.error('Camera start failed:', err);
            webcamContainer.style.display = 'none';
        }
    });
    
    // Cancel recording
    cancelBtn.addEventListener('click', function() {
        stopCamera();
        webcamContainer.style.display = 'none';
    });
    
    // Flip camera
    flipCameraBtn.addEventListener('click', async function() {
        currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
        await startCamera();
    });
    
    // Start camera function
    async function startCamera() {
        try {
            // Stop existing stream
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            
            // Mobile-friendly camera constraints
            const constraints = {
                video: { 
                    width: { ideal: 640, max: 1280 },
                    height: { ideal: 480, max: 720 },
                    facingMode: currentFacingMode
                },
                audio: true 
            };
            
            currentStream = await navigator.mediaDevices.getUserMedia(constraints);
            webcamPreview.srcObject = currentStream;
            flipCameraBtn.style.display = 'inline-block';
            recordVideoBtn.style.display = 'inline-block';
            console.log('Camera started successfully with facing mode:', currentFacingMode);
        } catch (err) {
            console.error('Camera access error:', err);
            let errorMsg = 'Error accessing camera: ' + err.message;
            if (err.name === 'NotAllowedError') {
                errorMsg += '\n\nPlease allow camera access in your browser settings.';
            } else if (err.name === 'NotFoundError') {
                errorMsg += '\n\nNo camera found. Please check your device.';
            }
            alert(errorMsg);
            throw err;
        }
    }
    
    // Stop camera function
    function stopCamera() {
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
            currentStream = null;
        }
        webcamPreview.srcObject = null;
        flipCameraBtn.style.display = 'none';
        recordVideoBtn.style.display = 'none';
        stopBtn.style.display = 'none';
        recordingStatus.style.display = 'none';
        if (recordingInterval) {
            clearInterval(recordingInterval);
        }
    }
    
    // Start recording
    recordVideoBtn.addEventListener('click', function() {
        if (!currentStream) {
            alert('Camera not available. Please try again.');
            return;
        }
        
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(currentStream);
        
        mediaRecorder.ondataavailable = function(event) {
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        };
        
        mediaRecorder.onstop = function() {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const file = new File([blob], 'webcam-recording.webm', { type: 'video/webm' });
            
            // Set the file to the input
            setFileToInput(file);
            
            // Show success and stop camera
            videoName.textContent = 'Webcam Recording (' + Math.round(file.size / 1024) + ' KB)';
            videoPreview.style.display = 'block';
            stopCamera();
            
            console.log('Video recorded successfully, file size:', file.size, 'bytes');
        };
        
        mediaRecorder.start();
        recordVideoBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
        recordingStatus.style.display = 'block';
        
        recordingStartTime = Date.now();
        recordingInterval = setInterval(updateRecordingTime, 1000);
    });
    
    // Helper function to set file to input
    function setFileToInput(file) {
        try {
            console.log('Setting file to input:', file.name, file.size, 'bytes');
            
            // Store the file globally for form submission
            window.recordedVideoFile = file;
            
            // Try modern DataTransfer API first
            if (window.DataTransfer && window.DataTransfer.prototype.items) {
                try {
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    videoInput.files = dataTransfer.files;
                    console.log('File set using DataTransfer API');
                } catch (e) {
                    console.warn('DataTransfer API failed, trying fallback:', e);
                    throw e; // This will trigger the fallback
                }
            } else {
                throw new Error('DataTransfer not supported');
            }
            
            // Verify the file was set
            if (videoInput.files && videoInput.files.length > 0) {
                console.log('File successfully set to input:', videoInput.files[0].name, videoInput.files[0].size);
            } else {
                throw new Error('File not set in input');
            }
        } catch (e) {
            console.warn('Primary method failed, using global file storage:', e);
            // Fallback: store file globally and modify form submission
            window.recordedVideoFile = file;
            console.log('File stored globally for form submission');
        }
    }
    
    // Stop recording
    stopBtn.addEventListener('click', function() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
        }
        
        stopBtn.style.display = 'none';
        recordVideoBtn.style.display = 'inline-block';
        recordingStatus.style.display = 'none';
        if (recordingInterval) {
            clearInterval(recordingInterval);
        }
    });
    
    // Update recording time
    function updateRecordingTime() {
        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        recordingTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // Form submission handler
    const form = document.querySelector('form');
    const submitBtn = document.getElementById('submit-btn');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (validateForm()) {
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating Exercise...';
            
            // Submit the form
            form.submit();
        }
    });
    
    // Form validation
    function validateForm() {
        const name = document.getElementById('name').value.trim();
        
        console.log('Validating form...');
        console.log('Name:', name);
        console.log('Video input files:', videoInput.files);
        console.log('Video input files length:', videoInput.files ? videoInput.files.length : 'null');
        console.log('Global recorded file:', window.recordedVideoFile);
        
        if (!name) {
            alert('Please enter an exercise name.');
            return false;
        }
        
        // Check for video file in input or global storage
        let file = null;
        if (videoInput.files && videoInput.files.length > 0) {
            file = videoInput.files[0];
            console.log('Using file from input:', file.name, file.size, 'bytes');
        } else if (window.recordedVideoFile) {
            file = window.recordedVideoFile;
            console.log('Using globally stored file:', file.name, file.size, 'bytes');
            // Set the file to the input for form submission
            try {
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                videoInput.files = dataTransfer.files;
            } catch (e) {
                console.warn('Could not set file to input, but will proceed with global file');
            }
        }
        
        if (!file) {
            console.error('No video file found in input or global storage');
            alert('Please upload a video file or record a video.');
            return false;
        }
        
        console.log('Video file details:', file.name, file.size, 'bytes', file.type);
        
        if (file.size === 0) {
            alert('The video file appears to be empty. Please try again.');
            return false;
        }
        
        console.log('Form validation passed, submitting exercise with video:', file.name, file.size, 'bytes');
        return true;
    }
});
</script>
{% endblock %}
