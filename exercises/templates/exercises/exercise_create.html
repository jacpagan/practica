{% extends 'exercises/base.html' %}

{% block title %}Create Exercise - Practika{% endblock %}

{% block content %}
<div id="create-exercise-container" class="card">
    <h1>Create New Exercise</h1>
    
    <!-- Camera Access Notice -->
    <div class="alert alert-info" style="background-color: #e3f2fd; border: 1px solid #2196f3; border-radius: 4px; padding: 12px; margin-bottom: 20px;">
        <strong>ğŸ“¹ Camera Recording:</strong> 
        {% if request.is_secure %}
            âœ… Available - You can record videos directly
        {% else %}
            âš ï¸ Upload Only - Camera recording requires HTTPS. Please use the upload option below.
        {% endif %}
    </div>
    
    <form method="post" enctype="multipart/form-data" class="form-section">
        {% csrf_token %}
        
        <div class="form-group">
            <label for="name">ğŸ“ Exercise Name:</label>
            <input type="text" id="name" name="name" required placeholder="Enter exercise name...">
        </div>
        
        <div class="form-group">
            <label for="description">ğŸ“„ Description:</label>
            <textarea id="description" name="description" rows="3" placeholder="Describe your exercise..."></textarea>
        </div>
        
        <div class="form-group">
            <label for="video">ğŸ¥ Video:</label>
            <input type="file" id="video" name="video" accept="video/*" style="display: none;">
            <div class="video-options">
                <button type="button" id="upload-btn" class="btn btn-secondary" title="ğŸ“ Upload Video">ğŸ“ Upload</button>
                <button type="button" id="record-btn" class="btn btn-primary" title="ğŸ¥ Record Video">ğŸ¥ Record</button>
                <button type="button" id="youtube-btn" class="btn btn-success" title="ğŸ“º Add YouTube Video">ğŸ“º YouTube</button>
            </div>
            <div id="video-preview" style="display: none;">
                <p>âœ… Video ready: <span id="video-name"></span></p>
                <video id="video-playback" controls style="display: none; width: 100%; max-width: 400px; border-radius: 8px; margin-top: 10px;"></video>
                <button type="button" id="change-video" class="btn btn-sm btn-outline">Record Again</button>
            </div>
            <div id="webcam-container" style="display: none;">
                <video id="webcam-preview" autoplay muted playsinline 
                       style="width: 100%; max-width: 400px; border-radius: 8px;"
                       preload="none" disablePictureInPicture></video>
                <div class="webcam-controls" style="margin-top: 10px;">
                    <button type="button" id="flip-camera" class="btn btn-sm btn-secondary" style="display: none;" title="ğŸ”„ Flip Camera">ğŸ”„</button>
                    <button type="button" id="record-video" class="btn btn-danger" style="display: none;" title="ğŸ”´ Start Recording">ğŸ”´</button>
                    <button type="button" id="stop-recording" class="btn btn-warning" style="display: none;" title="â¹ï¸ Stop Recording">â¹ï¸</button>
                    <button type="button" id="cancel-recording" class="btn btn-sm btn-outline" title="âŒ Cancel">âŒ</button>
                </div>
                <div id="recording-status" style="display: none;">
                    <p>ğŸ”´ Recording... <span id="recording-time">00:00</span></p>
                </div>
            </div>
            
            <div id="youtube-container" style="display: none;">
                <div class="form-group">
                    <label for="youtube-url">ğŸ“º YouTube Video URL:</label>
                    <input type="url" id="youtube-url" name="youtube_url" 
                           placeholder="https://www.youtube.com/watch?v=..." 
                           pattern="https?://(?:www\.)?(?:youtube\.com|youtu\.be)/.*"
                           title="Please enter a valid YouTube URL">
                    <div class="form-help">Paste a YouTube video URL (e.g., https://www.youtube.com/watch?v=VIDEO_ID)</div>
                </div>
                <div id="youtube-preview" style="display: none;">
                    <div class="youtube-video-container">
                        <iframe id="youtube-embed" width="100%" height="300" 
                                frameborder="0" allowfullscreen 
                                style="border-radius: 8px; margin-top: 10px;"></iframe>
                    </div>
                    <button type="button" id="change-youtube" class="btn btn-sm btn-outline" style="margin-top: 10px;">Change YouTube URL</button>
                </div>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="submit-btn" title="âœ… Create Exercise">âœ… Create Exercise</button>
        </div>
    </form>
</div>

<script>
// Simplified video recording functionality - Version 2.1 (Enhanced Error Handling)
document.addEventListener('DOMContentLoaded', function() {
    console.log('Practika video recording v2.1 loaded - Enhanced error handling');
    
    // Check browser compatibility
    if (!navigator.mediaDevices) {
        console.warn('MediaDevices API not supported - camera recording disabled');
        // Disable record button and show message
        const recordBtn = document.getElementById('record-btn');
        if (recordBtn) {
            recordBtn.disabled = true;
            recordBtn.title = 'Camera recording not supported in this browser';
            recordBtn.textContent = 'ğŸ“· Not Supported';
        }
    }
    const uploadBtn = document.getElementById('upload-btn');
    const recordBtn = document.getElementById('record-btn');
    const youtubeBtn = document.getElementById('youtube-btn');
    const videoInput = document.getElementById('video');
    const videoPreview = document.getElementById('video-preview');
    const videoName = document.getElementById('video-name');
    const webcamContainer = document.getElementById('webcam-container');
    const youtubeContainer = document.getElementById('youtube-container');
    const youtubeUrlInput = document.getElementById('youtube-url');
    const youtubePreview = document.getElementById('youtube-preview');
    const youtubeEmbed = document.getElementById('youtube-embed');
    const changeYoutubeBtn = document.getElementById('change-youtube');
    const flipCameraBtn = document.getElementById('flip-camera');
    const recordVideoBtn = document.getElementById('record-video');
    const stopBtn = document.getElementById('stop-recording');
    const cancelBtn = document.getElementById('cancel-recording');
    const changeVideoBtn = document.getElementById('change-video');
    const webcamPreview = document.getElementById('webcam-preview');
    const recordingStatus = document.getElementById('recording-status');
    const recordingTime = document.getElementById('recording-time');
    const videoPlayback = document.getElementById('video-playback');
    
    let mediaRecorder;
    let recordedChunks = [];
    let recordingStartTime;
    let recordingInterval;
    let currentStream = null;
    let currentFacingMode = 'user'; // Start with front camera
    
    // Upload button click
    uploadBtn.addEventListener('click', function() {
        videoInput.click();
        youtubeContainer.style.display = 'none';
        webcamContainer.style.display = 'none';
    });
    
    // YouTube URL input change
    youtubeUrlInput.addEventListener('input', function() {
        const url = this.value.trim();
        if (isValidYouTubeUrl(url)) {
            const videoId = extractYouTubeVideoId(url);
            if (videoId) {
                youtubeEmbed.src = `https://www.youtube.com/embed/${videoId}`;
                youtubePreview.style.display = 'block';
                // Store YouTube URL globally for form submission
                window.youtubeVideoUrl = url;
            }
        } else {
            youtubePreview.style.display = 'none';
            window.youtubeVideoUrl = null;
        }
    });
    
    // Change YouTube URL button
    changeYoutubeBtn.addEventListener('click', function() {
        youtubePreview.style.display = 'none';
        youtubeUrlInput.value = '';
        youtubeUrlInput.focus();
        window.youtubeVideoUrl = null;
    });
    
    // YouTube URL validation function
    function isValidYouTubeUrl(url) {
        const patterns = [
            /^https?:\/\/(?:www\.)?youtube\.com\/watch\?v=[a-zA-Z0-9_-]{11}/,
            /^https?:\/\/youtu\.be\/[a-zA-Z0-9_-]{11}/,
            /^https?:\/\/(?:www\.)?youtube\.com\/embed\/[a-zA-Z0-9_-]{11}/
        ];
        return patterns.some(pattern => pattern.test(url));
    }
    
    // Extract YouTube video ID
    function extractYouTubeVideoId(url) {
        const patterns = [
            /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
            /youtube\.com\/watch\?.*v=([a-zA-Z0-9_-]{11})/
        ];
        
        for (const pattern of patterns) {
            const match = url.match(pattern);
            if (match) {
                return match[1];
            }
        }
        return null;
    }
    
    // Change video button click
    changeVideoBtn.addEventListener('click', function() {
        videoPreview.style.display = 'none';
        videoInput.value = '';
        if (videoPlayback) {
            videoPlayback.pause();
            videoPlayback.removeAttribute('src');
            videoPlayback.style.display = 'none';
        }
    });
    
    // File input change
    videoInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const file = this.files[0];
            videoName.textContent = file.name;
            videoPreview.style.display = 'block';
            webcamContainer.style.display = 'none';
            if (videoPlayback) {
                videoPlayback.src = URL.createObjectURL(file);
                videoPlayback.style.display = 'block';
                videoPlayback.play().catch(() => {});
            }
            // Clear any globally stored recorded file
            window.recordedVideoFile = null;
        }
    });
    
    // Record button click - start camera immediately
    recordBtn.addEventListener('click', async function() {
        webcamContainer.style.display = 'block';
        videoPreview.style.display = 'none';
        youtubeContainer.style.display = 'none';
        
        try {
            await startCamera();
        } catch (err) {
            console.error('Camera start failed:', err);
            webcamContainer.style.display = 'none';
        }
    });
    
    // YouTube button click
    youtubeBtn.addEventListener('click', function() {
        youtubeContainer.style.display = 'block';
        videoPreview.style.display = 'none';
        webcamContainer.style.display = 'none';
        youtubePreview.style.display = 'none';
        youtubeUrlInput.value = '';
    });
    
    // Cancel recording
    cancelBtn.addEventListener('click', function() {
        stopCamera();
        webcamContainer.style.display = 'none';
    });
    
    // Flip camera
    flipCameraBtn.addEventListener('click', async function() {
        currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
        await startCamera();
    });
    
    // Start camera function
    async function startCamera() {
        try {
            // Stop existing stream
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            
            // Check if MediaDevices API is available
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                throw new Error('Camera access not supported in this browser. Please use a modern browser or upload a video file instead.');
            }
            
            // Performance-optimized camera constraints
            const constraints = {
                video: { 
                    width: { ideal: 640, max: 1280 },
                    height: { ideal: 480, max: 720 },
                    facingMode: currentFacingMode,
                    // Performance optimizations
                    frameRate: { ideal: 30, max: 30 },
                    aspectRatio: { ideal: 16/9 },
                    // Reduce processing overhead
                    resizeMode: 'crop-and-scale'
                },
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true,
                    sampleRate: 44100,
                    channelCount: 1
                }
            };
            
            const startTime = performance.now();
            currentStream = await navigator.mediaDevices.getUserMedia(constraints);
            const endTime = performance.now();
            
            console.log(`Camera started in ${(endTime - startTime).toFixed(2)}ms with facing mode:`, currentFacingMode);
            
            // Set video properties for better performance
            webcamPreview.srcObject = currentStream;
            webcamPreview.onloadedmetadata = function() {
                console.log('Video metadata loaded, dimensions:', webcamPreview.videoWidth, 'x', webcamPreview.videoHeight);
            };
            
            flipCameraBtn.style.display = 'inline-block';
            recordVideoBtn.style.display = 'inline-block';
        } catch (err) {
            console.error('Camera access error:', err);
            let errorMsg = 'Error accessing camera: ' + err.message;
            
            if (err.message.includes('not supported')) {
                errorMsg = 'Camera recording is not supported in this browser. Please use the upload option instead.';
            } else if (err.name === 'NotAllowedError') {
                errorMsg = 'Camera access denied. Please allow camera access in your browser settings or use the upload option.';
            } else if (err.name === 'NotFoundError') {
                errorMsg = 'No camera found. Please check your device or use the upload option.';
            } else if (err.name === 'NotSupportedError') {
                errorMsg = 'Camera access not supported. Please use the upload option instead.';
            } else if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                errorMsg = 'Camera access requires HTTPS. For now, please use the upload option. Contact support to enable HTTPS for camera recording.';
            }
            
            alert(errorMsg);
            // Hide camera container and show upload option
            webcamContainer.style.display = 'none';
            throw err;
        }
    }
    
    // Stop camera function
    function stopCamera() {
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
            currentStream = null;
        }
        webcamPreview.srcObject = null;
        flipCameraBtn.style.display = 'none';
        recordVideoBtn.style.display = 'none';
        stopBtn.style.display = 'none';
        recordingStatus.style.display = 'none';
        if (recordingInterval) {
            clearInterval(recordingInterval);
        }
    }
    
    // Start recording
    recordVideoBtn.addEventListener('click', function() {
        if (!currentStream) {
            alert('Camera not available. Please try again.');
            return;
        }
        
        recordedChunks = [];
        
        // Performance-optimized MediaRecorder settings
        const options = {
            mimeType: 'video/webm;codecs=vp8,opus',
            videoBitsPerSecond: 2500000, // 2.5 Mbps for good quality/size balance
            audioBitsPerSecond: 128000   // 128 kbps audio
        };
        
        // Fallback to default if codec not supported
        if (!MediaRecorder.isTypeSupported(options.mimeType)) {
            options.mimeType = 'video/webm';
        }
        
        mediaRecorder = new MediaRecorder(currentStream, options);
        
        // Optimize data collection frequency
        mediaRecorder.ondataavailable = function(event) {
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        };
        
        mediaRecorder.onstop = function() {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const file = new File([blob], 'webcam-recording.webm', { type: 'video/webm' });
            
            // Set the file to the input
            setFileToInput(file);
            
            // Show success and stop camera
            videoName.textContent = 'Webcam Recording (' + Math.round(file.size / 1024) + ' KB)';
            videoPreview.style.display = 'block';
            if (videoPlayback) {
                videoPlayback.src = URL.createObjectURL(blob);
                videoPlayback.style.display = 'block';
                videoPlayback.play().catch(() => {});
            }
            stopCamera();
            
            console.log('Video recorded successfully, file size:', file.size, 'bytes');
        };
        
        // Start recording with optimized timeslice for better performance
        mediaRecorder.start(1000); // 1-second chunks for smoother processing
        recordVideoBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
        recordingStatus.style.display = 'block';
        
        recordingStartTime = Date.now();
        recordingInterval = setInterval(updateRecordingTime, 1000);
    });
    
    // Helper function to set file to input
    function setFileToInput(file) {
        try {
            console.log('Setting file to input:', file.name, file.size, 'bytes');
            
            // Store the file globally for form submission
            window.recordedVideoFile = file;
            
            // Try modern DataTransfer API first
            if (window.DataTransfer && window.DataTransfer.prototype.items) {
                try {
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    videoInput.files = dataTransfer.files;
                    console.log('File set using DataTransfer API');
                } catch (e) {
                    console.warn('DataTransfer API failed, trying fallback:', e);
                    throw e; // This will trigger the fallback
                }
            } else {
                throw new Error('DataTransfer not supported');
            }
            
            // Verify the file was set
            if (videoInput.files && videoInput.files.length > 0) {
                console.log('File successfully set to input:', videoInput.files[0].name, videoInput.files[0].size);
            } else {
                throw new Error('File not set in input');
            }
        } catch (e) {
            console.warn('Primary method failed, using global file storage:', e);
            // Fallback: store file globally and modify form submission
            window.recordedVideoFile = file;
            console.log('File stored globally for form submission');
        }
    }
    
    // Stop recording
    stopBtn.addEventListener('click', function() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
        }
        
        stopBtn.style.display = 'none';
        recordVideoBtn.style.display = 'inline-block';
        recordingStatus.style.display = 'none';
        if (recordingInterval) {
            clearInterval(recordingInterval);
        }
    });
    
    // Update recording time with performance monitoring
    function updateRecordingTime() {
        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        recordingTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // Monitor recording performance every 5 seconds
        if (elapsed % 5 === 0 && elapsed > 0) {
            const videoTrack = currentStream?.getVideoTracks()[0];
            if (videoTrack) {
                const settings = videoTrack.getSettings();
                console.log('Recording performance check:', {
                    frameRate: settings.frameRate,
                    width: settings.width,
                    height: settings.height,
                    elapsed: elapsed
                });
            }
        }
    }
    
    // Form submission handler
    const form = document.querySelector('form');
    const submitBtn = document.getElementById('submit-btn');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (validateForm()) {
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating Exercise...';
            
            // Submit the form
            form.submit();
        }
    });
    
    // Form validation
    function validateForm() {
        const name = document.getElementById('name').value.trim();
        
        console.log('Validating form...');
        console.log('Name:', name);
        console.log('Video input files:', videoInput.files);
        console.log('Video input files length:', videoInput.files ? videoInput.files.length : 'null');
        console.log('Global recorded file:', window.recordedVideoFile);
        
        if (!name) {
            alert('Please enter an exercise name.');
            return false;
        }
        
        // Check for video file in input, global storage, or YouTube URL
        let file = null;
        let youtubeUrl = null;
        
        if (videoInput.files && videoInput.files.length > 0) {
            file = videoInput.files[0];
            console.log('Using file from input:', file.name, file.size, 'bytes');
        } else if (window.recordedVideoFile) {
            file = window.recordedVideoFile;
            console.log('Using globally stored file:', file.name, file.size, 'bytes');
            // Set the file to the input for form submission
            try {
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                videoInput.files = dataTransfer.files;
            } catch (e) {
                console.warn('Could not set file to input, but will proceed with global file');
            }
        } else if (window.youtubeVideoUrl) {
            youtubeUrl = window.youtubeVideoUrl;
            console.log('Using YouTube URL:', youtubeUrl);
        }
        
        if (!file && !youtubeUrl) {
            console.error('No video file or YouTube URL found');
            alert('Please upload a video file, record a video, or add a YouTube URL.');
            return false;
        }
        
        if (file) {
            console.log('Video file details:', file.name, file.size, 'bytes', file.type);
            
            if (file.size === 0) {
                alert('The video file appears to be empty. Please try again.');
                return false;
            }
            
            console.log('Form validation passed, submitting exercise with video file:', file.name, file.size, 'bytes');
        } else if (youtubeUrl) {
            console.log('Form validation passed, submitting exercise with YouTube URL:', youtubeUrl);
        }
        
        return true;
    }
});
</script>
{% endblock %}
