{% extends 'exercises/base.html' %}

{% block title %}Create Exercise - Practika{% endblock %}

{% block content %}
<div class="card">
    <h1>Create New Exercise</h1>
    
    <form id="exerciseForm" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="form-group">
            <label for="title">Exercise Title:</label>
            <input type="text" id="title" name="title" required>
        </div>
        
        <div class="form-group">
            <label for="description">Description:</label>
            <textarea id="description" name="description" rows="3"></textarea>
        </div>
        
        <div class="form-group">
            <label>Video Recording:</label>
            <div id="videoSection" class="video-section">
                <div id="deviceInfo" class="device-info">
                    <div id="compatibilityStatus"></div>
                    <div id="deviceCapabilities"></div>
                </div>
                
                <div class="camera-controls">
                    <button type="button" id="switchCamera" class="btn btn-secondary" style="display: none;">
                        Switch Camera
                    </button>
                    <select id="cameraSelect" class="form-control" style="display: none;">
                        <option value="">Select Camera...</option>
                    </select>
                </div>
                
                <div class="video-preview">
                    <video id="videoPreview" playsinline muted style="display: none;"></video>
                    <canvas id="videoCanvas" style="display: none;"></canvas>
                    <div id="videoPlaceholder" class="video-placeholder">
                        Ready to record video
                    </div>
                </div>
                
                <div class="recording-controls">
                    <button type="button" id="startRecording" class="btn btn-primary">
                        Start Recording
                    </button>
                    <button type="button" id="stopRecording" class="btn btn-danger" style="display: none;">
                        Stop Recording
                    </button>
                    <button type="button" id="retakeVideo" class="btn btn-warning" style="display: none;">
                        Retake Video
                    </button>
                </div>
                
                <div id="recordingStatus" class="recording-status" style="display: none;">
                    <div class="recording-indicator">Recording...</div>
                    <div id="recordingTimer">00:00</div>
                </div>
                
                <div id="fallbackUpload" class="fallback-upload" style="display: none;">
                    <p>Camera not available? Upload a video file instead:</p>
                    <input type="file" id="videoFile" name="video" accept="video/*" capture="environment">
                    <label for="videoFile" class="file-upload-label">
                        Choose Video File
                    </label>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="category">Category:</label>
            <select id="category" name="category" required>
                <option value="">Select Category...</option>
                <option value="strength">Strength</option>
                <option value="cardio">Cardio</option>
                <option value="flexibility">Flexibility</option>
                <option value="balance">Balance</option>
                <option value="sports">Sports</option>
                <option value="other">Other</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="difficulty">Difficulty Level:</label>
            <select id="difficulty" name="difficulty" required>
                <option value="">Select Difficulty...</option>
                <option value="beginner">Beginner</option>
                <option value="intermediate">Intermediate</option>
                <option value="advanced">Advanced</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="duration">Estimated Duration (minutes):</label>
            <input type="number" id="duration" name="duration" min="1" max="180" value="10">
        </div>
        
        <div class="form-group">
            <label for="equipment">Equipment Needed:</label>
            <input type="text" id="equipment" name="equipment" placeholder="None, dumbbells, yoga mat, etc.">
        </div>
        
        <div class="form-group">
            <label for="instructions">Step-by-step Instructions:</label>
            <textarea id="instructions" name="instructions" rows="5" placeholder="Provide clear, numbered instructions for the exercise..."></textarea>
        </div>
        
        <div class="form-group">
            <label for="safety_notes">Safety Notes:</label>
            <textarea id="safety_notes" name="safety_notes" rows="3" placeholder="Any safety precautions or contraindications..."></textarea>
        </div>
        
        <div class="form-group">
            <label for="tags">Tags (comma-separated):</label>
            <input type="text" id="tags" name="tags" placeholder="e.g., core, balance, beginner-friendly">
        </div>
        
        <div class="form-group">
            <label>
                <input type="checkbox" id="is_public" name="is_public" checked>
                Make this exercise public
            </label>
        </div>
        
        <div class="form-group">
            <button type="submit" class="btn btn-success" id="submitBtn">
                Create Exercise
            </button>
            <a href="/exercises/" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
    // Video recording functionality
    class VideoRecorder {
        constructor(containerId) {
            this.container = document.getElementById(containerId);
            this.videoBlob = null;
            this.mediaRecorder = null;
            this.stream = null;
            this.recordedChunks = [];
            this.recordingTimer = null;
            this.recordingStartTime = null;
            
            this.initializeCamera();
        }
        
        async initializeCamera() {
            try {
                this.stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    }, 
                    audio: true 
                });
                
                const video = document.getElementById('videoPreview');
                video.srcObject = this.stream;
                video.style.display = 'block';
                document.getElementById('videoPlaceholder').style.display = 'none';
                
                // Show camera controls
                document.getElementById('startRecording').style.display = 'inline-block';
                document.getElementById('switchCamera').style.display = 'inline-block';
                
                // Check for multiple cameras
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                if (videoDevices.length > 1) {
                    const cameraSelect = document.getElementById('cameraSelect');
                    cameraSelect.style.display = 'inline-block';
                    
                    videoDevices.forEach(device => {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        option.textContent = device.label || `Camera ${cameraSelect.options.length + 1}`;
                        cameraSelect.appendChild(option);
                    });
                    
                    cameraSelect.addEventListener('change', () => this.switchCamera(device.deviceId));
                }
                
            } catch (error) {
                console.error('Camera access failed:', error);
                this.showFallbackUpload();
            }
        }
        
        async switchCamera(deviceId) {
            if (this.stream) {
                this.stream.getTracks().forEach(track => track.stop());
            }
            
            try {
                this.stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        deviceId: deviceId ? { exact: deviceId } : undefined,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: true
                });
                
                const video = document.getElementById('videoPreview');
                video.srcObject = this.stream;
                
            } catch (error) {
                console.error('Failed to switch camera:', error);
            }
        }
        
        startRecording() {
            if (!this.stream) return;
            
            this.recordedChunks = [];
            this.mediaRecorder = new MediaRecorder(this.stream, {
                mimeType: 'video/webm;codecs=vp9'
            });
            
            this.mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    this.recordedChunks.push(event.data);
                }
            };
            
            this.mediaRecorder.onstop = () => {
                this.videoBlob = new Blob(this.recordedChunks, { type: 'video/webm' });
                this.showRecordingPreview();
            };
            
            this.mediaRecorder.start();
            this.startRecordingTimer();
            this.updateRecordingUI(true);
        }
        
        stopRecording() {
            if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {
                this.mediaRecorder.stop();
                this.stopRecordingTimer();
                this.updateRecordingUI(false);
            }
        }
        
        startRecordingTimer() {
            this.recordingStartTime = Date.now();
            this.recordingTimer = setInterval(() => {
                const elapsed = Date.now() - this.recordingStartTime;
                const seconds = Math.floor(elapsed / 1000);
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                
                document.getElementById('recordingTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        stopRecordingTimer() {
            if (this.recordingTimer) {
                clearInterval(this.recordingTimer);
                this.recordingTimer = null;
            }
        }
        
        updateRecordingUI(isRecording) {
            const startBtn = document.getElementById('startRecording');
            const stopBtn = document.getElementById('stopRecording');
            const retakeBtn = document.getElementById('retakeVideo');
            const status = document.getElementById('recordingStatus');
            
            if (isRecording) {
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
                status.style.display = 'block';
            } else {
                startBtn.style.display = 'none';
                stopBtn.style.display = 'none';
                retakeBtn.style.display = 'inline-block';
                status.style.display = 'none';
            }
        }
        
        showRecordingPreview() {
            const video = document.getElementById('videoPreview');
            const canvas = document.getElementById('videoCanvas');
            const placeholder = document.getElementById('videoPlaceholder');
            
            // Create preview from recorded video
            const url = URL.createObjectURL(this.videoBlob);
            video.src = url;
            video.style.display = 'block';
            placeholder.style.display = 'none';
            
            // Show retake button
            document.getElementById('retakeVideo').style.display = 'inline-block';
        }
        
        reset() {
            this.videoBlob = null;
            this.recordedChunks = [];
            
            const video = document.getElementById('videoPreview');
            const placeholder = document.getElementById('videoPlaceholder');
            
            if (this.stream) {
                video.srcObject = this.stream;
                video.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                video.style.display = 'none';
                placeholder.style.display = 'block';
            }
            
            document.getElementById('startRecording').style.display = 'inline-block';
            document.getElementById('stopRecording').style.display = 'none';
            document.getElementById('retakeVideo').style.display = 'none';
            document.getElementById('recordingStatus').style.display = 'none';
        }
        
        showFallbackUpload() {
            document.getElementById('fallbackUpload').style.display = 'block';
            document.getElementById('startRecording').style.display = 'none';
            document.getElementById('switchCamera').style.display = 'none';
        }
    }
    
    // Initialize video recorder
    let videoRecorder;
    
    document.addEventListener('DOMContentLoaded', function() {
        videoRecorder = new VideoRecorder('videoSection');
        
        // Event listeners
        document.getElementById('startRecording').addEventListener('click', () => {
            videoRecorder.startRecording();
        });
        
        document.getElementById('stopRecording').addEventListener('click', () => {
            videoRecorder.stopRecording();
        });
        
        document.getElementById('retakeVideo').addEventListener('click', () => {
            videoRecorder.reset();
        });
        
        // Form submission
        document.getElementById('exerciseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const title = document.getElementById('title').value.trim();
            if (!title) {
                alert('Please enter an exercise title');
                return;
            }
            
            if (!videoRecorder.videoBlob && !document.getElementById('videoFile').files[0]) {
                alert('Please record or upload a video');
                return;
            }
            
            // Create FormData
            const formData = new FormData(this);
            
            // Add video data
            if (videoRecorder.videoBlob) {
                formData.set('video', videoRecorder.videoBlob, 'exercise.webm');
            }
            
            // Submit form
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.textContent = 'Creating...';
            submitBtn.disabled = true;
            
            fetch('/exercises/create/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = `/exercises/${data.exercise_id}/`;
                } else {
                    alert('Error creating exercise: ' + data.error);
                    submitBtn.textContent = 'Create Exercise';
                    submitBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating exercise. Please try again.');
                submitBtn.textContent = 'Create Exercise';
                submitBtn.disabled = false;
            });
        });
    });
</script>
{% endblock %}
