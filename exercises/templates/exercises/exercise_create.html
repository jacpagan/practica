{% extends 'exercises/base.html' %}

{% block title %}Create Exercise - Practika{% endblock %}

{% block content %}
<div class="create-exercise-container">
    <div class="header">
        <h2>üé• Create New Exercise</h2>
        <p class="subtitle">Record with webcam or upload a video file</p>
    </div>
    
    <form id="exercise-form" method="POST" enctype="multipart/form-data" action="{% url 'exercise_create' %}">
        {% csrf_token %}
        
        <!-- Basic Info Section -->
        <div class="form-section">
            <div class="form-group">
                <label for="name">Exercise Name *</label>
                <input type="text" id="name" name="name" required maxlength="140" 
                       placeholder="e.g., Morning Yoga Flow, Strength Training">
            </div>
            
            <div class="form-group">
                <label for="description">Description (optional)</label>
                <textarea id="description" name="description" rows="3" 
                          placeholder="Brief description of the exercise..."></textarea>
            </div>
        </div>
        
        <!-- Video Input Section -->
        <div class="form-section">
            <div class="video-source-toggle">
                <label class="toggle-label">Video Source</label>
                <div class="toggle-buttons">
                    <button type="button" class="toggle-btn active" data-source="webcam" aria-label="Record with webcam" title="Webcam">
                        <svg class="icon"><use href="/static/icons/icons.svg#camera"/></svg>
                        <span class="label-text">Webcam</span>
                    </button>
                    <button type="button" class="toggle-btn" data-source="file" aria-label="Upload video file" title="Upload File">
                        <svg class="icon"><use href="/static/icons/icons.svg#upload"/></svg>
                        <span class="label-text">Upload File</span>
                    </button>
                </div>
            </div>
            
            <!-- Webcam Recording -->
            <div id="webcam-section" class="video-section active">
                <div class="recorder-simple">
                    <div class="camera-preview">
                        <video id="preview-create" autoplay muted></video>
                        <div class="camera-overlay">
                            <div class="recording-status" id="recording-status">Ready to record</div>
                            <div class="recording-time" id="recording-time"></div>
                        </div>
                    </div>
                    
                    <div class="recording-controls">
                        <button type="button" id="start-recording" class="btn btn-primary btn-large" aria-label="Start recording video" title="Start Recording">
                            <svg class="icon icon-large"><use href="/static/icons/icons.svg#record"/></svg>
                            <span class="label-text">Start Recording</span>
                        </button>
                        <button type="button" id="stop-recording" class="btn btn-danger btn-large hidden" aria-label="Stop recording video" title="Stop Recording">
                            <svg class="icon icon-large"><use href="/static/icons/icons.svg#stop"/></svg>
                            <span class="label-text">Stop Recording</span>
                        </button>
                        <button type="button" id="reset-recording" class="btn btn-secondary hidden" aria-label="Record video again" title="Record Again">
                            <svg class="icon icon-large"><use href="/static/icons/icons.svg#camera"/></svg>
                            <span class="label-text">Record Again</span>
                        </button>
                    </div>
                    
                    <div class="recording-info">
                        <div class="info-item">
                            <span class="icon">üìπ</span>
                            <span id="video-status">No video recorded yet</span>
                        </div>
                        <div class="info-item">
                            <span class="icon">‚è±Ô∏è</span>
                            <span id="video-duration">0:00</span>
                        </div>
                        <div class="info-item" id="video-ready-indicator" style="display: none;">
                            <span class="icon">‚úÖ</span>
                            <span style="color: green; font-weight: bold;">Video Ready!</span>
                        </div>
                        <div class="info-item">
                            <button type="button" id="debug-video-btn" class="btn btn-small" style="display: none;" onclick="debugVideoStatus()">
                                üîç Debug Video
                            </button>
                            <button type="button" id="force-data-btn" class="btn btn-small" style="display: none;" onclick="forceDataCollection()">
                                üì° Force Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- File Upload -->
            <div id="file-section" class="video-section">
                <div class="file-upload-area">
                    <div class="upload-zone" id="upload-zone">
                        <div class="upload-icon">üìÅ</div>
                        <div class="upload-text">
                            <strong>Click to select video</strong><br>
                            or drag and drop here
                        </div>
                        <input type="file" id="video-file" name="video" accept="video/*" hidden>
                    </div>
                    
                    <div class="file-preview" id="file-preview" style="display: none;">
                        <video id="video-preview" controls></video>
                        <div class="file-info">
                            <span id="file-name"></span>
                            <span id="file-size"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Progress Section -->
        <div id="progress-section" class="progress-section" style="display: none;">
            <div class="progress-header">
                <h4>üîÑ Creating Exercise...</h4>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
            
            <div class="progress-steps">
                <div class="step" id="step-1">
                    <div class="step-icon">1</div>
                    <div class="step-content">
                        <div class="step-title">Validating</div>
                        <div class="step-status" id="step-1-status">Checking details...</div>
                    </div>
                </div>
                <div class="step" id="step-2">
                    <div class="step-icon">2</div>
                    <div class="step-content">
                        <div class="step-title">Processing Video</div>
                        <div class="step-status" id="step-2-status">Waiting...</div>
                    </div>
                </div>
                <div class="step" id="step-3">
                    <div class="step-icon">3</div>
                    <div class="step-content">
                        <div class="step-title">Uploading</div>
                        <div class="step-status" id="step-3-status">Waiting...</div>
                    </div>
                </div>
                <div class="step" id="step-4">
                    <div class="step-icon">4</div>
                    <div class="step-content">
                        <div class="step-title">Saving</div>
                        <div class="step-status" id="step-4-status">Waiting...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hidden video input for form submission -->
        <input type="hidden" id="video-data" name="video_data">
        
        <!-- Action Buttons -->
        <div class="form-actions">
            <button type="submit" id="submit-btn" class="btn btn-success btn-large" aria-label="Create exercise" title="Create Exercise">
                <svg class="icon icon-large"><use href="/static/icons/icons.svg#save"/></svg>
                <span class="label-text">Create Exercise</span>
            </button>
            <a href="{% url 'exercise_list' %}" class="btn btn-secondary" aria-label="Cancel and return to exercise list" title="Cancel">
                <svg class="icon icon-large"><use href="/static/icons/icons.svg#back"/></svg>
                <span class="label-text">Cancel</span>
            </a>
        </div>
    </form>
</div>

<script>
    // Simple Video Recorder for Create Page
    class SimpleVideoRecorder {
        constructor() {
            this.stream = null;
            this.mediaRecorder = null;
            this.recordedChunks = [];
            this.isRecording = false;
            this.recordingStartTime = null;
            this.durationTimer = null;
            
            this.setupElements();
            this.bindEvents();
        }
        
        setupElements() {
            this.preview = document.getElementById('preview-create');
            this.startBtn = document.getElementById('start-recording');
            this.stopBtn = document.getElementById('stop-recording');
            this.resetBtn = document.getElementById('reset-recording');
            this.status = document.getElementById('recording-status');
            this.time = document.getElementById('recording-time');
            this.videoStatus = document.getElementById('video-status');
            this.videoDuration = document.getElementById('video-duration');
        }
        
        bindEvents() {
            this.startBtn.addEventListener('click', () => this.startRecording());
            this.stopBtn.addEventListener('click', () => this.stopRecording());
            this.resetBtn.addEventListener('click', () => this.reset());
        }
        
        async startRecording() {
            try {
                this.status.textContent = 'Starting...';
                
                // Clear any previous recordings
                this.recordedChunks = [];
                
                this.stream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                
                this.preview.srcObject = this.stream;
                // Try different MIME types in order of preference
                const mimeTypes = [
                    'video/webm;codecs=vp8,opus',
                    'video/webm;codecs=vp8',
                    'video/webm',
                    'video/mp4'
                ];
                
                let selectedMimeType = null;
                for (const mimeType of mimeTypes) {
                    if (MediaRecorder.isTypeSupported(mimeType)) {
                        selectedMimeType = mimeType;
                        console.log('Using MIME type:', selectedMimeType);
                        break;
                    }
                }
                
                if (!selectedMimeType) {
                    console.error('No supported MIME type found');
                    this.status.textContent = 'Unsupported video format';
                    return;
                }
                
                this.mediaRecorder = new MediaRecorder(this.stream, {
                    mimeType: selectedMimeType
                });
                
                this.mediaRecorder.ondataavailable = (event) => {
                    console.log('Data available event:', { size: event.data.size, type: event.data.type });
                    if (event.data.size > 0) {
                        this.recordedChunks.push(event.data);
                        console.log('Video chunk received:', { size: event.data.size, totalChunks: this.recordedChunks.length });
                    } else {
                        console.warn('Empty data chunk received');
                    }
                };
                

                
                // Request data more frequently to ensure we get chunks
                this.mediaRecorder.start(100); // Every 100ms instead of 1000ms
                this.isRecording = true;
                this.recordingStartTime = Date.now();
                this.startDurationTimer();
                this.updateUI();
                
                this.status.textContent = 'Recording...';
                this.status.className = 'recording-status recording';
                
                console.log('Recording started');
                
            } catch (error) {
                this.status.textContent = 'Camera access denied';
                console.error('Camera error:', error);
            }
        }
        
        startDurationTimer() {
            this.durationTimer = setInterval(() => {
                if (this.isRecording && this.recordingStartTime) {
                    const duration = Math.floor((Date.now() - this.recordingStartTime) / 1000);
                    const minutes = Math.floor(duration / 60);
                    const seconds = duration % 60;
                    const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    this.time.textContent = timeString;
                    this.videoDuration.textContent = timeString;
                }
            }, 1000);
        }
        
        stopRecording() {
            if (this.mediaRecorder && this.isRecording) {
                clearInterval(this.durationTimer);
                
                this.mediaRecorder.stop();
                this.stream.getTracks().forEach(track => track.stop());
                this.isRecording = false;
                
                this.status.textContent = 'Processing...';
                this.status.className = 'recording-status processing';
                
                // Wait for the final data to be available
                this.mediaRecorder.onstop = () => {
                    setTimeout(() => {
                        // Force collect any remaining data
                        console.log('MediaRecorder stopped, final chunks:', this.recordedChunks.length);
                        
                        // Force a final data collection if no chunks
                        if (this.recordedChunks.length === 0) {
                            console.warn('No chunks collected, trying to force data collection...');
                            // This is a fallback - in some browsers we might need to handle this differently
                        }
                        
                        this.status.textContent = 'Ready!';
                        this.status.className = 'recording-status ready';
                        this.videoStatus.textContent = 'Video ready for upload';
                        this.updateUI();
                        
                        // Show video ready indicator
                        document.getElementById('video-ready-indicator').style.display = 'block';
                        
                        // Show debug button
                        document.getElementById('debug-video-btn').style.display = 'inline-block';
                        
                        // Show force data button
                        document.getElementById('force-data-btn').style.display = 'inline-block';
                        
                        // Enable the submit button
                        document.getElementById('submit-btn').disabled = false;
                        
                        // Add visual feedback
                        document.getElementById('submit-btn').classList.add('btn-success');
                        document.getElementById('submit-btn').classList.remove('btn-secondary');
                        
                        console.log('Video recording completed and ready, chunks:', this.recordedChunks.length);
                    }, 500);
                };
            }
        }
        
        updateUI() {
            if (this.isRecording) {
                this.startBtn.classList.add('hidden');
                this.stopBtn.classList.remove('hidden');
                this.resetBtn.classList.add('hidden');
            } else if (this.recordedChunks.length > 0) {
                this.startBtn.classList.add('hidden');
                this.stopBtn.classList.add('hidden');
                this.resetBtn.classList.remove('hidden');
            } else {
                this.startBtn.classList.remove('hidden');
                this.stopBtn.classList.add('hidden');
                this.resetBtn.classList.add('hidden');
            }
        }
        
        getVideoBlob() {
            console.log('getVideoBlob() called, chunks:', this.recordedChunks ? this.recordedChunks.length : 0);
            if (this.recordedChunks && this.recordedChunks.length > 0) {
                const blob = new Blob(this.recordedChunks, { type: 'video/webm' });
                console.log('Video blob created:', { size: blob.size, chunks: this.recordedChunks.length });
                return blob;
            }
            console.log('No video chunks available');
            return null;
        }
        
        hasVideo() {
            const blob = this.getVideoBlob();
            const hasVideo = blob !== null && blob.size > 0;
            console.log('hasVideo() called:', { hasVideo, blobExists: !!blob, blobSize: blob ? blob.size : 0 });
            return hasVideo;
        }
        
        forceRefreshVideo() {
            // Force a refresh of the video blob
            if (this.recordedChunks.length > 0) {
                const blob = new Blob(this.recordedChunks, { type: 'video/webm' });
                console.log('Force refreshed video blob:', { size: blob.size, chunks: this.recordedChunks.length });
                return blob;
            }
            return null;
        }
        
        requestData() {
            // Manually request data from MediaRecorder if it's still active
            if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {
                console.log('Manually requesting data from MediaRecorder');
                this.mediaRecorder.requestData();
            }
        }
        
        reset() {
            this.recordedChunks = [];
            this.preview.srcObject = null;
            this.preview.src = '';
            this.status.textContent = 'Ready to record';
            this.status.className = 'recording-status';
            this.time.textContent = '';
            this.videoStatus.textContent = 'No video recorded yet';
            this.videoDuration.textContent = '0:00';
            
            // Hide video ready indicator
            document.getElementById('video-ready-indicator').style.display = 'none';
            
            this.updateUI();
        }
    }
    
    // Initialize when page loads
    let videoRecorder; // Declare globally
    
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize video recorder
        videoRecorder = new SimpleVideoRecorder();
        console.log('VideoRecorder initialized:', videoRecorder);
        
        // Toggle between webcam and file upload
        const toggleBtns = document.querySelectorAll('.toggle-btn');
        const videoSections = document.querySelectorAll('.video-section');
        
        toggleBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const source = this.dataset.source;
                
                // Update toggle buttons
                toggleBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Show/hide sections
                videoSections.forEach(section => {
                    section.classList.remove('active');
                    if (section.id === `${source}-section`) {
                        section.classList.add('active');
                    }
                });
            });
        });
        
        // File upload handling
        const uploadZone = document.getElementById('upload-zone');
        const videoFile = document.getElementById('video-file');
        const filePreview = document.getElementById('file-preview');
        const videoPreview = document.getElementById('video-preview');
        const fileName = document.getElementById('file-name');
        const fileSize = document.getElementById('file-size');
        
        uploadZone.addEventListener('click', () => videoFile.click());
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });
        
        videoFile.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });
        
        function handleFileSelect(file) {
            if (file.type.startsWith('video/')) {
                const url = URL.createObjectURL(file);
                videoPreview.src = url;
                
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                
                uploadZone.style.display = 'none';
                filePreview.style.display = 'block';
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Progress tracking
        function updateStep(stepNumber, status, message) {
            const step = document.getElementById(`step-${stepNumber}`);
            const stepStatus = document.getElementById(`step-${stepNumber}-status`);
            const stepIcon = step.querySelector('.step-icon');
            
            step.className = `step ${status}`;
            stepIcon.className = `step-icon ${status}`;
            stepStatus.textContent = message;
            
            // Update progress bar
            const completedSteps = document.querySelectorAll('.step.completed').length;
            const progress = (completedSteps / 4) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
        }
        
        // Form submission
        document.getElementById('exercise-form').addEventListener('submit', function(e) {
            // Validate form
            const name = document.getElementById('name').value.trim();
            if (!name) {
                e.preventDefault();
                alert('Exercise name is required');
                return;
            }
            
            // Check if video is available
            const activeSource = document.querySelector('.toggle-btn.active').dataset.source;
            let hasVideo = false;
            
            if (activeSource === 'webcam') {
                // More detailed webcam video check
                const videoBlob = videoRecorder.getVideoBlob();
                const hasVideoMethod = videoRecorder.hasVideo();
                hasVideo = hasVideoMethod && videoBlob && videoBlob.size > 0;
                
                console.log('Webcam video check:', { 
                    hasVideo, 
                    hasVideoMethod, 
                    blobExists: !!videoBlob, 
                    blobSize: videoBlob ? videoBlob.size : 0,
                    chunks: videoRecorder.recordedChunks ? videoRecorder.recordedChunks.length : 0
                });
                
                // If we have chunks but no blob, try to create one
                if (!hasVideo && videoRecorder.recordedChunks && videoRecorder.recordedChunks.length > 0) {
                    console.log('Attempting to create blob from chunks...');
                    const tempBlob = new Blob(videoRecorder.recordedChunks, { type: 'video/webm' });
                    if (tempBlob.size > 0) {
                        hasVideo = true;
                        console.log('Successfully created blob from chunks:', { size: tempBlob.size });
                    }
                }
            } else {
                const fileInput = document.getElementById('video-file');
                hasVideo = fileInput.files.length > 0 && fileInput.files[0].size > 0;
                console.log('File upload check:', { hasVideo, fileCount: fileInput.files.length });
            }
            
            if (!hasVideo) {
                e.preventDefault();
                alert('Please record or upload a video first. Make sure the video is complete and ready.');
                return;
            }
            
            // Convert webcam video to file if needed
            if (activeSource === 'webcam') {
                const videoBlob = videoRecorder.getVideoBlob();
                if (videoBlob && videoBlob.size > 0) {
                    // Create a file input for the webcam video
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.name = 'video';
                    fileInput.style.display = 'none';
                    
                    // Convert blob to file
                    const videoFile = new File([videoBlob], 'exercise.webm', { type: 'video/webm' });
                    
                    // Create a new DataTransfer and add the file
                    const dt = new DataTransfer();
                    dt.items.add(videoFile);
                    fileInput.files = dt.files;
                    
                    // Add to form
                    document.getElementById('exercise-form').appendChild(fileInput);
                    
                    console.log('Webcam video converted to file:', { fileName: videoFile.name, fileSize: videoFile.size });
                }
            }
            
            // Show progress
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';
        });
    });
    
    // Debug function to check video status
    function debugVideoStatus() {
        try {
            const activeSource = document.querySelector('.toggle-btn.active').dataset.source;
            console.log('=== VIDEO DEBUG INFO ===');
            console.log('Active source:', activeSource);
            
            if (activeSource === 'webcam') {
                if (typeof videoRecorder === 'undefined') {
                    console.error('ERROR: videoRecorder is not defined!');
                    console.log('Available global variables:', Object.keys(window).filter(key => key.includes('video') || key.includes('recorder')));
                    return;
                }
                
                console.log('VideoRecorder state:', {
                    isRecording: videoRecorder.isRecording,
                    chunks: videoRecorder.recordedChunks ? videoRecorder.recordedChunks.length : 0,
                    hasVideo: videoRecorder.hasVideo(),
                    getVideoBlob: videoRecorder.getVideoBlob(),
                    forceRefresh: videoRecorder.forceRefreshVideo()
                });
            } else {
                const fileInput = document.getElementById('video-file');
                console.log('File input state:', {
                    files: fileInput.files,
                    fileCount: fileInput.files.length,
                    firstFile: fileInput.files[0] ? {
                        name: fileInput.files[0].name,
                        size: fileInput.files[0].size,
                        type: fileInput.files[0].type
                    } : null
                });
            }
            
            // Test form validation
            const name = document.getElementById('name').value.trim();
            console.log('Form validation test:', {
                name: name,
                nameValid: !!name
            });
            
            alert('Check browser console for detailed video debug information');
        } catch (error) {
            console.error('Debug function error:', error);
            alert('Error in debug function: ' + error.message);
        }
    }
    
    // Force data collection function
    function forceDataCollection() {
        try {
            if (typeof videoRecorder === 'undefined') {
                alert('VideoRecorder not available');
                return;
            }
            
            console.log('=== FORCING DATA COLLECTION ===');
            
            // Try to request data if still recording
            videoRecorder.requestData();
            
            // Check current state
            console.log('Current chunks:', videoRecorder.recordedChunks ? videoRecorder.recordedChunks.length : 0);
            
            // Try to create a blob anyway
            const blob = videoRecorder.forceRefreshVideo();
            if (blob) {
                console.log('Successfully created blob after force refresh:', { size: blob.size });
                alert('Data collected! Check console for details.');
            } else {
                console.log('Still no data available');
                alert('No data available even after force collection.');
            }
        } catch (error) {
            console.error('Force data collection error:', error);
            alert('Error in force data collection: ' + error.message);
        }
    }
</script>
{% endblock %}
