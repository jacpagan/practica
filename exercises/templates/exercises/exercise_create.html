{% extends 'exercises/base.html' %}

{% block title %}Create Exercise - Practika{% endblock %}

{% block content %}
<style>
    .recording-controls {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-bottom: 1.5rem;
        align-items: center;
    }
    
    .btn {
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        justify-content: center;
    }
    
    .btn-large {
        padding: 1rem 2rem;
        font-size: 1.1rem;
        border-radius: 8px;
        min-width: 160px;
    }
    
    .btn-small {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        border-radius: 6px;
        min-width: 120px;
    }
    
    .btn-primary {
        background: #3498db;
        color: white;
    }
    
    .btn-primary:hover {
        background: #2980b9;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    }
    
    .btn-danger {
        background: #e74c3c;
        color: white;
    }
    
    .btn-danger:hover {
        background: #c0392b;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
    }
    
    .btn-success {
        background: #27ae60;
        color: white;
    }
    
    .btn-success:hover {
        background: #229954;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
    }
    
    .btn-secondary {
        background: #95a5a6;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #7f8c8d;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(149, 165, 166, 0.3);
    }
    
    .hidden {
        display: none !important;
    }
    
    .recording-status.ready {
        background: rgba(39, 174, 96, 0.9);
        animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
</style>

<div class="create-exercise-container">
    <div class="header">
        <h2>üé• Create New Exercise</h2>
        <p class="subtitle">Record with webcam or upload a video file</p>
    </div>
    
    <form id="exercise-form" method="POST" enctype="multipart/form-data" action="{% url 'exercise_create' %}">
        {% csrf_token %}
        
        <!-- Basic Info Section -->
        <div class="form-section">
            <div class="form-group">
                <label for="name">Exercise Name *</label>
                <input type="text" id="name" name="name" required maxlength="140" 
                       placeholder="e.g., Morning Yoga Flow, Strength Training">
            </div>
            
            <div class="form-group">
                <label for="description">Description (optional)</label>
                <textarea id="description" name="description" rows="3" 
                          placeholder="Brief description of the exercise..."></textarea>
            </div>
        </div>
        
        <!-- Video Input Section -->
        <div class="form-section">
            <div class="video-source-toggle">
                <label class="toggle-label">Video Source</label>
                <div class="toggle-buttons">
                    <button type="button" class="toggle-btn active" data-source="webcam" aria-label="Record with webcam" title="Webcam">
                        <svg class="icon"><use href="/static/icons/icons.svg#camera"/></svg>
                        <span class="label-text">Webcam</span>
                    </button>
                    <button type="button" class="toggle-btn" data-source="file" aria-label="Upload video file" title="Upload File">
                        <svg class="icon"><use href="/static/icons/icons.svg#upload"/></svg>
                        <span class="label-text">Upload File</span>
                    </button>
                </div>
            </div>
            
            <!-- Webcam Recording -->
            <div id="webcam-section" class="video-section active">
                <div class="recorder-simple">
                    <div class="camera-preview">
                        <video id="preview-create" autoplay muted></video>
                        <div class="camera-overlay">
                            <div class="recording-status" id="recording-status">Ready to record</div>
                            <div class="recording-time" id="recording-time"></div>
                        </div>
                    </div>
                    
                    <div class="recording-controls">
                        <button type="button" id="record-toggle-btn" class="btn btn-primary btn-large" aria-label="Start recording video" title="Start Recording">
                            <svg class="icon icon-large"><use href="/static/icons/icons.svg#record"/></svg>
                            <span class="label-text">Start Recording</span>
                        </button>
                        <button type="button" id="upload-video-btn" class="btn btn-success btn-large hidden" aria-label="Upload recorded video" title="Upload Video">
                            <svg class="icon icon-large"><use href="/static/icons/icons.svg#save"/></svg>
                            <span class="label-text">Upload Video</span>
                        </button>
                        <button type="button" id="reset-recording" class="btn btn-secondary btn-small" aria-label="Record video again" title="Record Again">
                            <svg class="icon icon-small"><use href="/static/icons/icons.svg#camera"/></svg>
                            <span class="label-text">Record Again</span>
                        </button>
                    </div>
                    
                    <div class="recording-info">
                        <div class="info-item">
                            <span class="icon">üìπ</span>
                            <span id="video-status">No video recorded yet</span>
                        </div>
                        <div class="info-item">
                            <span class="icon">‚è±Ô∏è</span>
                            <span id="video-duration">0:00</span>
                        </div>
                        <div class="info-item" id="video-ready-indicator" style="display: none;">
                            <span class="icon">‚úÖ</span>
                            <span style="color: green; font-weight: bold;">Video Ready!</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- File Upload -->
            <div id="file-section" class="video-section">
                <div class="file-upload-area">
                    <div class="upload-zone" id="upload-zone">
                        <div class="upload-icon">üìÅ</div>
                        <div class="upload-text">
                            <strong>Click to select video</strong><br>
                            or drag and drop here
                        </div>
                        <input type="file" id="video-file" name="video" accept="video/*" hidden>
                    </div>
                    
                    <div class="file-preview" id="file-preview" style="display: none;">
                        <video id="video-preview" controls></video>
                        <div class="file-info">
                            <span id="file-name"></span>
                            <span id="file-size"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Progress Section -->
        <div id="progress-section" class="progress-section" style="display: none;">
            <div class="progress-header">
                <h4>üîÑ Creating Exercise...</h4>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
            
            <div class="progress-steps">
                <div class="step" id="step-1">
                    <div class="step-icon">1</div>
                    <div class="step-content">
                        <div class="step-title">Validating</div>
                        <div class="step-status" id="step-1-status">Checking details...</div>
                    </div>
                </div>
                <div class="step" id="step-2">
                    <div class="step-icon">2</div>
                    <div class="step-content">
                        <div class="step-title">Processing Video</div>
                        <div class="step-status" id="step-2-status">Waiting...</div>
                    </div>
                </div>
                <div class="step" id="step-3">
                    <div class="step-icon">3</div>
                    <div class="step-content">
                        <div class="step-title">Uploading</div>
                        <div class="step-status" id="step-3-status">Waiting...</div>
                    </div>
                </div>
                <div class="step" id="step-4">
                    <div class="step-icon">4</div>
                    <div class="step-content">
                        <div class="step-title">Saving</div>
                        <div class="step-status" id="step-4-status">Waiting...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hidden video input for form submission -->
        <input type="hidden" id="video-data" name="video_data">
        
        <!-- Action Buttons -->
        <div class="form-actions">
            <button type="submit" id="submit-btn" class="btn btn-secondary btn-large" disabled aria-label="Create exercise" title="Create Exercise">
                <svg class="icon icon-large"><use href="/static/icons/icons.svg#save"/></svg>
                <span class="label-text">Create Exercise</span>
            </button>
            <a href="{% url 'exercise_list' %}" class="btn btn-secondary" aria-label="Cancel and return to exercise list" title="Cancel">
                <svg class="icon icon-large"><use href="/static/icons/icons.svg#back"/></svg>
                <span class="label-text">Cancel</span>
            </a>
        </div>
    </form>
</div>

<script>
    // Simple Video Recorder for Create Page
    class SimpleVideoRecorder {
        constructor() {
            this.stream = null;
            this.mediaRecorder = null;
            this.recordedChunks = [];
            this.isRecording = false;
            this.recordingStartTime = null;
            this.durationTimer = null;
            
            this.setupElements();
            this.bindEvents();
        }
        
        setupElements() {
            this.preview = document.getElementById('preview-create');
            this.recordToggleBtn = document.getElementById('record-toggle-btn');
            this.uploadBtn = document.getElementById('upload-video-btn');
            this.resetBtn = document.getElementById('reset-recording');
            this.status = document.getElementById('recording-status');
            this.time = document.getElementById('recording-time');
            this.videoStatus = document.getElementById('video-status');
            this.videoDuration = document.getElementById('video-duration');
            
            // Check if all required elements are found
            if (!this.preview || !this.recordToggleBtn || !this.uploadBtn || !this.resetBtn || !this.status || !this.time || !this.videoStatus || !this.videoDuration) {
                throw new Error('Required DOM elements not found for video recorder');
            }
        }
        
        bindEvents() {
            try {
                this.recordToggleBtn.addEventListener('click', () => this.toggleRecording());
                this.uploadBtn.addEventListener('click', () => this.uploadVideo());
                this.resetBtn.addEventListener('click', () => this.reset());
            } catch (error) {
                console.error('Failed to bind video recorder events:', error);
                throw error;
            }
        }
        
        async startRecording() {
            try {
                this.status.textContent = 'Starting...';
                
                // Clear any previous recordings
                this.recordedChunks = [];
                
                // Heroku HTTPS requirement - ensure we're using secure context
                if (!window.isSecureContext) {
                    throw new Error('Camera access requires HTTPS (required on Heroku)');
                }
                
                this.stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    }, 
                    audio: { 
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });
                
                this.preview.srcObject = this.stream;
                
                // Use a simple, reliable MIME type
                const mimeType = 'video/webm';
                
                this.mediaRecorder = new MediaRecorder(this.stream, { mimeType });
                
                this.mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        this.recordedChunks.push(event.data);
                        console.log('Video chunk received:', { size: event.data.size, totalChunks: this.recordedChunks.length });
                    }
                };
                
                this.mediaRecorder.onerror = (event) => {
                    console.error('MediaRecorder error:', event.error);
                    this.status.textContent = 'Recording error: ' + event.error.message;
                    this.isRecording = false;
                    this.updateUI();
                };
                
                this.mediaRecorder.onstart = () => {
                    console.log('MediaRecorder started successfully');
                };
                
                this.mediaRecorder.onstop = () => {
                    console.log('MediaRecorder stopped');
                    this.status.textContent = 'Video Ready!';
                    this.status.className = 'recording-status ready';
                    this.videoStatus.textContent = 'Video ready for upload';
                    
                    // Show video ready indicator
                    document.getElementById('video-ready-indicator').style.display = 'block';
                    
                    // Stop the stream
                    if (this.stream) {
                        this.stream.getTracks().forEach(track => track.stop());
                        this.stream = null;
                    }
                    
                    // Update UI to show upload button
                    this.updateUI();
                };
                
                // Start recording with 1-second intervals for reliable data collection
                this.mediaRecorder.start(1000);
                this.isRecording = true;
                this.recordingStartTime = Date.now();
                this.startDurationTimer();
                this.updateUI();
                
                this.status.textContent = 'Recording...';
                this.status.className = 'recording-status recording';
                
                console.log('Recording started');
                
            } catch (error) {
                console.error('Camera error:', error);
                
                // Heroku-specific error messages
                if (error.name === 'NotAllowedError') {
                    this.status.textContent = 'Camera access denied - please allow camera permissions';
                } else if (error.name === 'NotSupportedError') {
                    this.status.textContent = 'Camera not supported - please use a modern browser';
                } else if (error.message.includes('HTTPS')) {
                    this.status.textContent = 'HTTPS required for camera access (Heroku requirement)';
                } else {
                    this.status.textContent = 'Camera error: ' + error.message;
                }
                
                // Reset recording state on error
                this.isRecording = false;
                this.updateUI();
            }
        }
        
        toggleRecording() {
            if (this.isRecording) {
                this.stopRecording();
            } else {
                this.startRecording();
            }
        }
        
        uploadVideo() {
            try {
                // Validate video before upload
                const validation = this.validateVideoForUpload();
                if (!validation.valid) {
                    alert('Video validation failed: ' + validation.error);
                    return;
                }
                
                const videoBlob = validation.blob;
                
                // Create a file input for the webcam video
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.name = 'video';
                fileInput.style.display = 'none';
                
                // Convert blob to file
                const videoFile = new File([videoBlob], 'exercise.webm', { type: 'video/webm' });
                
                // Create a new DataTransfer and add the file
                const dt = new DataTransfer();
                dt.items.add(videoFile);
                fileInput.files = dt.files;
                
                // Remove any existing video input first
                const existingVideoInput = document.querySelector('input[name="video"]');
                if (existingVideoInput) {
                    existingVideoInput.remove();
                }
                
                // Add to form
                document.getElementById('exercise-form').appendChild(fileInput);
                
                console.log('Video prepared for upload:', { fileName: videoFile.name, fileSize: videoFile.size });
                
                // Heroku performance logging
                if (isHeroku) {
                    console.log('Heroku: Video upload prepared successfully', {
                        size: videoFile.size,
                        duration: this.recordingStartTime ? Math.round((Date.now() - this.recordingStartTime) / 1000) : 'unknown',
                        chunks: this.recordedChunks.length
                    });
                }
                
                // Update UI to show video is ready
                this.status.textContent = 'Video Ready for Upload!';
                this.status.className = 'recording-status ready';
                
                // Enable the submit button
                document.getElementById('submit-btn').disabled = false;
                document.getElementById('submit-btn').classList.add('btn-success');
                document.getElementById('submit-btn').classList.remove('btn-secondary');
                
                // Show video ready indicator
                document.getElementById('video-ready-indicator').style.display = 'block';
                
                // Update button states
                this.updateUI();
                
                alert('Video has been prepared for upload! You can now submit the exercise.');
                
            } catch (error) {
                console.error('Error preparing video for upload:', error);
                alert('Error preparing video for upload: ' + error.message);
            }
        }
        
        startDurationTimer() {
            this.durationTimer = setInterval(() => {
                if (this.isRecording && this.recordingStartTime) {
                    const duration = Math.floor((Date.now() - this.recordingStartTime) / 1000);
                    const minutes = Math.floor(duration / 60);
                    const seconds = duration % 60;
                    const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    this.time.textContent = timeString;
                    this.videoDuration.textContent = timeString;
                }
            }, 1000);
        }
        
        stopRecording() {
            if (this.mediaRecorder && this.isRecording) {
                console.log('Stopping recording...');
                clearInterval(this.durationTimer);
                
                this.isRecording = false;
                
                // Simply stop the MediaRecorder
                this.mediaRecorder.stop();
                
                this.status.textContent = 'Processing...';
                this.status.className = 'recording-status processing';
            }
        }
        
        updateUI() {
            console.log('updateUI called:', { 
                isRecording: this.isRecording, 
                chunks: this.recordedChunks.length,
                hasVideo: this.hasVideo()
            });
            
            if (this.isRecording) {
                // Recording state: show stop button
                this.recordToggleBtn.innerHTML = '<svg class="icon icon-large"><use href="/static/icons/icons.svg#stop"/></svg><span class="label-text">Stop Recording</span>';
                this.recordToggleBtn.className = 'btn btn-danger btn-large';
                this.recordToggleBtn.classList.remove('hidden');
                this.uploadBtn.classList.add('hidden');
                this.resetBtn.classList.add('hidden');
            } else if (this.isReadyForUpload()) {
                // Ready state: show upload button
                this.recordToggleBtn.classList.add('hidden');
                this.uploadBtn.classList.remove('hidden');
                this.resetBtn.classList.remove('hidden');
            } else {
                // Initial state: show record button
                this.recordToggleBtn.innerHTML = '<svg class="icon icon-large"><use href="/static/icons/icons.svg#record"/></svg><span class="label-text">Start Recording</span>';
                this.recordToggleBtn.className = 'btn btn-primary btn-large';
                this.recordToggleBtn.classList.remove('hidden');
                this.uploadBtn.classList.add('hidden');
                this.resetBtn.classList.add('hidden');
            }
        }
        
        getVideoBlob() {
            console.log('getVideoBlob() called, chunks:', this.recordedChunks ? this.recordedChunks.length : 0);
            if (this.recordedChunks && this.recordedChunks.length > 0) {
                const blob = new Blob(this.recordedChunks, { type: 'video/webm' });
                console.log('Video blob created:', { size: blob.size, chunks: this.recordedChunks.length });
                return blob;
            }
            console.log('No video chunks available');
            return null;
        }
        
        hasVideo() {
            const blob = this.getVideoBlob();
            const hasVideo = blob !== null && blob.size > 0;
            console.log('hasVideo() called:', { hasVideo, blobExists: !!blob, blobSize: blob ? blob.size : 0 });
            return hasVideo;
        }
        
        isReadyForUpload() {
            return this.recordedChunks.length > 0 && this.hasVideo();
        }
        
        validateVideoForUpload() {
            const blob = this.getVideoBlob();
            if (!blob || blob.size === 0) {
                return { valid: false, error: 'No video data available' };
            }
            
            // Check file size (100MB limit for Heroku)
            const maxSize = 100 * 1024 * 1024;
            if (blob.size > maxSize) {
                return { 
                    valid: false, 
                    error: `Video too large (${(blob.size / 1024 / 1024).toFixed(1)}MB). Maximum is 100MB.` 
                };
            }
            
            // Check duration (max 10 minutes)
            if (this.recordingStartTime) {
                const duration = Date.now() - this.recordingStartTime;
                const maxDuration = 10 * 60 * 1000; // 10 minutes
                if (duration > maxDuration) {
                    return { 
                        valid: false, 
                        error: `Video too long (${Math.round(duration / 1000 / 60)} minutes). Maximum is 10 minutes.` 
                    };
                }
            }
            
            return { valid: true, blob };
        }
        
        reset() {
            this.recordedChunks = [];
            this.preview.srcObject = null;
            this.preview.src = '';
            this.status.textContent = 'Ready to record';
            this.status.className = 'recording-status';
            this.time.textContent = '';
            this.videoStatus.textContent = 'No video recorded yet';
            this.videoDuration.textContent = '0:00';
            
            // Hide video ready indicator
            document.getElementById('video-ready-indicator').style.display = 'none';
            
            // Remove any existing video file input
            const existingVideoInput = document.querySelector('input[name="video"]');
            if (existingVideoInput) {
                existingVideoInput.remove();
            }
            
            // Disable submit button
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.className = 'btn btn-secondary btn-large';
            
            // Reset button states
            this.updateUI();
        }
    }
    
    // Initialize when page loads
    let videoRecorder; // Declare globally
    
    // Heroku environment detection
    const isHeroku = window.location.hostname.includes('herokuapp.com') || 
                     window.location.protocol === 'https:';
    
    if (isHeroku) {
        console.log('Running on Heroku - HTTPS and security features enabled');
    }
    
    // Global error handler for unhandled promise rejections
    window.addEventListener('unhandledrejection', function(event) {
        console.error('Unhandled promise rejection:', event.reason);
        // Prevent the default browser behavior
        event.preventDefault();
    });
    
    document.addEventListener('DOMContentLoaded', function() {
        try {
            // Check if SimpleVideoRecorder class is defined
            if (typeof SimpleVideoRecorder === 'undefined') {
                throw new Error('SimpleVideoRecorder class is not defined');
            }
            
            // Initialize video recorder
            videoRecorder = new SimpleVideoRecorder();
            console.log('VideoRecorder initialized:', videoRecorder);
            
            // Ensure initial UI state is correct
            videoRecorder.updateUI();
        } catch (error) {
            console.error('Failed to initialize VideoRecorder:', error);
            videoRecorder = null;
        }
        
        // Toggle between webcam and file upload
        const toggleBtns = document.querySelectorAll('.toggle-btn');
        const videoSections = document.querySelectorAll('.video-section');
        
        toggleBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const source = this.dataset.source;
                
                // Update toggle buttons
                toggleBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Show/hide sections
                videoSections.forEach(section => {
                    section.classList.remove('active');
                    if (section.id === `${source}-section`) {
                        section.classList.add('active');
                    }
                });
            });
        });
        
        // File upload handling
        const uploadZone = document.getElementById('upload-zone');
        const videoFile = document.getElementById('video-file');
        const filePreview = document.getElementById('file-preview');
        const videoPreview = document.getElementById('video-preview');
        const fileName = document.getElementById('file-name');
        const fileSize = document.getElementById('file-size');
        
        uploadZone.addEventListener('click', () => videoFile.click());
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });
        
        videoFile.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });
        
        function handleFileSelect(file) {
            if (file.type.startsWith('video/')) {
                const url = URL.createObjectURL(file);
                videoPreview.src = url;
                
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                
                uploadZone.style.display = 'none';
                filePreview.style.display = 'block';
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Progress tracking
        function updateStep(stepNumber, status, message) {
            const step = document.getElementById(`step-${stepNumber}`);
            const stepStatus = document.getElementById(`step-${stepNumber}-status`);
            const stepIcon = step.querySelector('.step-icon');
            
            step.className = `step ${status}`;
            stepIcon.className = `step-icon ${status}`;
            stepStatus.textContent = message;
            
            // Update progress bar
            const completedSteps = document.querySelectorAll('.step.completed').length;
            const progress = (completedSteps / 4) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
        }
        
        // Form submission
        document.getElementById('exercise-form').addEventListener('submit', function(e) {
            // Validate form
            const name = document.getElementById('name').value.trim();
            if (!name) {
                e.preventDefault();
                alert('Exercise name is required');
                return;
            }
            
            // Check if video is available
            const activeSource = document.querySelector('.toggle-btn.active').dataset.source;
            let hasVideo = false;
            
            if (activeSource === 'webcam') {
                // Check if videoRecorder is available
                if (!videoRecorder) {
                    console.error('VideoRecorder not available');
                    e.preventDefault();
                    alert('Video recorder not available. Please refresh the page and try again.');
                    return;
                }
                
                // More detailed webcam video check
                const videoBlob = videoRecorder.getVideoBlob();
                const hasVideoMethod = videoRecorder.hasVideo();
                hasVideo = hasVideoMethod && videoBlob && videoBlob.size > 0;
                
                console.log('Webcam video check:', { 
                    hasVideo, 
                    hasVideoMethod, 
                    blobExists: !!videoBlob, 
                    blobSize: videoBlob ? videoBlob.size : 0,
                    chunks: videoRecorder.recordedChunks ? videoRecorder.recordedChunks.length : 0
                });
                
                // If we have chunks but no blob, try to create one
                if (!hasVideo && videoRecorder.recordedChunks && videoRecorder.recordedChunks.length > 0) {
                    console.log('Attempting to create blob from chunks...');
                    const tempBlob = new Blob(videoRecorder.recordedChunks, { type: 'video/webm' });
                    if (tempBlob.size > 0) {
                        hasVideo = true;
                        console.log('Successfully created blob from chunks:', { size: tempBlob.size });
                    }
                }
            } else {
                const fileInput = document.getElementById('video-file');
                hasVideo = fileInput.files.length > 0 && fileInput.files[0].size > 0;
                console.log('File upload check:', { hasVideo, fileCount: fileInput.files.length });
            }
            
            if (!hasVideo) {
                e.preventDefault();
                alert('Please record or upload a video first. Make sure the video is complete and ready.');
                return;
            }
            
            // Check if webcam video has already been prepared for upload
            if (activeSource === 'webcam') {
                // The uploadVideo method should have already prepared the video
                // Just verify it's still available
                const existingVideoInput = document.querySelector('input[name="video"]');
                if (!existingVideoInput || !existingVideoInput.files || existingVideoInput.files.length === 0) {
                    e.preventDefault();
                    alert('Please use the Upload Video button to prepare your recorded video first.');
                    return;
                }
                
                // Additional validation for webcam video
                const videoFile = existingVideoInput.files[0];
                if (videoFile.size === 0) {
                    e.preventDefault();
                    alert('Video file appears to be empty. Please record a new video.');
                    return;
                }
                
                console.log('Webcam video validated for submission:', {
                    name: videoFile.name,
                    size: videoFile.size,
                    type: videoFile.type
                });
            }
            
            // Show progress
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';
        });
    });
</script>
{% endblock %}
