{% extends 'exercises/base.html' %}

{% block title %}{{ exercise.name }} - Practika{% endblock %}

{% block content %}
<div class="card">
    <h2>{{ exercise.name }}</h2>
    {% if exercise.description %}
        <p>{{ exercise.description }}</p>
    {% endif %}
    
    <div class="meta">
        <p><strong>Created by:</strong> {{ exercise.created_by.username }}</p>
        <p><strong>Created:</strong> {{ exercise.created_at|date:"M d, Y H:i" }}</p>
        <p><strong>Last updated:</strong> {{ exercise.updated_at|date:"M d, Y H:i" }}</p>
    </div>
    
    <div class="video-container">
        <h3>Exercise Video</h3>
        <video class="video-player" controls>
            <source src="{{ exercise.video_asset.get_public_url }}" type="{{ exercise.video_asset.mime_type }}">
            Your browser does not support the video tag.
        </video>
    </div>

    <div class="comments-section">
        <h3>Video Comments ({{ exercise.videocomment_set.count }})</h3>
        
        {% for comment in exercise.videocomment_set.all %}
        <div class="comment">
            <div class="meta">
                <strong>{{ comment.author.username }}</strong>
                {% if comment.author.is_staff %}<span class="admin-badge">Admin</span>{% endif %}
                <span>{{ comment.created_at|date:"M d, Y H:i" }}</span>
            </div>
            
            {% if comment.text %}
                <p>{{ comment.text }}</p>
            {% endif %}
            
            <div class="video-container">
                <video class="video-player" controls>
                    <source src="{{ comment.video_asset.get_public_url }}" type="{{ comment.video_asset.mime_type }}">
                    Your browser does not support the video tag.
                </video>
            </div>
        </div>
        {% empty %}
            <p>No comments yet. Be the first to comment!</p>
        {% endfor %}
        
        {% if user.is_authenticated %}
            <div class="card">
                <h4>Add Comment</h4>
                {% csrf_token %}
                <div class="form-group">
                    <label for="comment-text">Text (optional)</label>
                    <textarea id="comment-text" rows="2" placeholder="Add text..."></textarea>
                </div>
                <div id="recorder-container-main" class="recorder-container">
                    <p>Video recording functionality is available on the create exercise page.</p>
                    <p>To add a video comment, please use the file upload option below.</p>
                </div>
                
                <div class="form-group">
                    <label for="video-file">Video File:</label>
                    <input type="file" id="video-file" name="video" accept="video/*" required>
                </div>
                
                <div id="comment-progress-main" style="display: none;">
                    <div class="minimal-progress">
                        <div class="status-dots">
                            <div class="status-dot" id="comment-dot-1" data-state="processing"></div>
                            <div class="status-dot" id="comment-dot-2" data-state="uploading"></div>
                            <div class="status-dot" id="comment-dot-3" data-state="saving"></div>
                        </div>
                        <div class="minimal-status">
                            <div class="status-text" id="comment-status-text">Processing...</div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="submitComment()">
                    Submit
                </button>
            </div>
        {% endif %}
    </div>
</div>

<script>
    // Initialize main video recorder
    document.addEventListener('DOMContentLoaded', function() {
        if (document.getElementById('recorder-container-main')) {
            // Define VideoRecorder class if not already defined
            if (typeof VideoRecorder === 'undefined') {
                class VideoRecorder {
                    constructor(containerId) {
                        this.container = document.getElementById(containerId);
                        this.videoBlob = null;
                        this.mediaRecorder = null;
                        this.stream = null;
                        this.recordedChunks = [];
                    }
                    
                    startRecording() {
                        // Basic implementation for comment recording
                        alert('Video recording functionality not available on this page. Please use the create exercise page for full recording features.');
                    }
                    
                    stopRecording() {
                        // Basic implementation
                    }
                    
                    reset() {
                        // Basic implementation
                    }
                }
            }
            
            window.videoRecorders = window.videoRecorders || {};
            window.videoRecorders['main'] = new VideoRecorder('recorder-container-main');
        }
    });

    // Update comment progress dots
    function updateCommentDot(dotNumber, state) {
        const dot = document.getElementById(`comment-dot-${dotNumber}`);
        if (dot) {
            dot.className = `status-dot ${state}`;
            dot.setAttribute('data-state', state);
        }
    }

    // Submit comment function
    function submitComment() {
        const text = document.getElementById('comment-text').value;
        const videoFile = document.getElementById('video-file').files[0];
        
        if (!videoFile) {
            alert('Please select a video file.');
            return;
        }
        
        // Show progress
        document.getElementById('comment-progress-main').style.display = 'block';
        
        // Create form data
        const formData = new FormData();
        formData.append('text', text);
        formData.append('video', videoFile);
        formData.append('exercise', '{{ exercise.id }}');
        
        // Submit comment
        fetch('/comments/api/comments/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error submitting comment: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error submitting comment. Please try again.');
        });
    }
</script>
{% endblock %}
