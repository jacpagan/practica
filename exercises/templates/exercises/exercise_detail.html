{% extends 'exercises/base.html' %}

{% block title %}{{ exercise.name }} - Practika{% endblock %}

{% block content %}
<div class="card">
    <h2>{{ exercise.name }}</h2>
    {% if exercise.description %}
        <p>{{ exercise.description }}</p>
    {% endif %}
    
    <div class="meta">
        <p><strong>Created by:</strong> {{ exercise.created_by.username }}</p>
        <p><strong>Created:</strong> {{ exercise.created_at|date:"M d, Y H:i" }}</p>
        <p><strong>Last updated:</strong> {{ exercise.updated_at|date:"M d, Y H:i" }}</p>
    </div>
    
    <div class="video-container">
        <h3>Exercise Video</h3>
        {% if exercise.video_asset %}
            {% if exercise.video_asset.youtube_url and exercise.video_asset.get_youtube_embed_url %}
                <div class="youtube-video-container">
                    <iframe 
                        src="{{ exercise.video_asset.get_youtube_embed_url }}" 
                        width="100%" 
                        height="400" 
                        frameborder="0" 
                        allowfullscreen
                        style="border-radius: 8px;"
                        title="YouTube video player">
                    </iframe>
                </div>
            {% elif exercise.video_asset.processing_status == 'completed' %}
                <video class="video-player" controls>
                    <source src="{{ exercise.video_asset.get_public_url }}" type="{{ exercise.video_asset.mime_type }}">
                    Your browser does not support the video tag.
                </video>
            {% else %}
                <p>Video processing: {{ exercise.video_asset.processing_status }}</p>
            {% endif %}
        {% else %}
            <p>No video available for this exercise.</p>
        {% endif %}
    </div>

    <div class="comments-section">
        <h3>Video Comments ({{ exercise.videocomment_set.count }})</h3>
        
        {% for comment in exercise.videocomment_set.all %}
        <div class="comment">
            <div class="meta">
                <strong>{{ comment.author.username }}</strong>
                {% if comment.author.is_staff %}<span class="admin-badge">Admin</span>{% endif %}
                <span>{{ comment.created_at|date:"M d, Y H:i" }}</span>
                
                {% if user == comment.author or user.is_staff %}
                <div class="comment-actions">
                    <a href="{% url 'comments:edit_comment' comment.id %}" class="btn btn-sm btn-warning" title="âœï¸ Edit Comment">âœï¸</a>
                    <a href="{% url 'comments:delete_comment' comment.id %}" class="btn btn-sm btn-danger" 
                       onclick="return confirm('Are you sure you want to delete this comment?')" title="ğŸ—‘ï¸ Delete Comment">ğŸ—‘ï¸</a>
                </div>
                {% endif %}
            </div>
            
            {% if comment.text %}
                <p>{{ comment.text }}</p>
            {% endif %}
            
            <div class="comment-video">
                {% if comment.video_asset %}
                    {% if comment.video_asset.youtube_url and comment.video_asset.get_youtube_embed_url %}
                        <div class="youtube-video-container">
                            <iframe 
                                src="{{ comment.video_asset.get_youtube_embed_url }}" 
                                width="300" 
                                height="200" 
                                frameborder="0" 
                                allowfullscreen
                                style="border-radius: 8px;"
                                title="YouTube video player">
                            </iframe>
                        </div>
                    {% elif comment.video_asset.processing_status == 'completed' %}
                        <video controls width="300" height="200">
                            <source src="{{ comment.video_asset.get_public_url }}" type="{{ comment.video_asset.mime_type }}">
                            Your browser does not support the video tag.
                        </video>
                    {% else %}
                        <p>Video processing: {{ comment.video_asset.processing_status }}</p>
                    {% endif %}
                {% else %}
                    <p>No video available for this comment.</p>
                {% endif %}
            </div>
        </div>
        {% empty %}
            <p>No comments yet. Be the first to comment!</p>
        {% endfor %}
        
        {% if user.is_authenticated %}
            <div class="card">
                <h4>Add Comment</h4>
                <form method="post" action="{% url 'comments:add_comment' exercise.id %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="comment-text">ğŸ’¬ Comment Text:</label>
                        <textarea id="comment-text" name="text" rows="3" placeholder="Write your comment here..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>ğŸ¥ Video Comment (Required):</label>
                        <input type="file" name="video" accept="video/*" style="display: none;">
                        <div class="video-options">
                            <button type="button" id="upload-btn" class="btn btn-sm btn-secondary" title="ğŸ“ Upload Video">ğŸ“ Upload</button>
                            <button type="button" id="record-btn" class="btn btn-sm btn-primary" title="ğŸ¥ Record Video">ğŸ¥ Record</button>
                            <button type="button" id="youtube-btn" class="btn btn-sm btn-success" title="ğŸ“º Add YouTube Video">ğŸ“º YouTube</button>
                        </div>
                        <div id="video-preview" style="display: none;">
                            <p>âœ… Video ready: <span id="video-name"></span></p>
                            <video id="comment-video-playback" controls style="display: none; width: 100%; max-width: 300px; border-radius: 8px; margin-top: 10px;"></video>
                            <button type="button" id="comment-change-video" class="btn btn-sm btn-outline">Record Again</button>
                        </div>
                        <div id="webcam-container" style="display: none;">
                            <video id="webcam-preview" autoplay muted playsinline></video>
                            <div class="webcam-controls">
                                <button type="button" id="start-camera" class="btn btn-sm btn-primary" title="ğŸ“· Start Camera">ğŸ“·</button>
                                <button type="button" id="flip-camera" class="btn btn-sm btn-secondary" style="display: none;" title="ğŸ”„ Flip Camera">ğŸ”„</button>
                                <button type="button" id="record-video" class="btn btn-sm btn-danger" style="display: none;" title="ğŸ”´ Record">ğŸ”´</button>
                                <button type="button" id="stop-recording" class="btn btn-sm btn-warning" style="display: none;" title="â¹ï¸ Stop">â¹ï¸</button>
                            </div>
                            <div id="recording-status" style="display: none;">
                                <p>ğŸ”´ Recording... <span id="recording-time">00:00</span></p>
                            </div>
                        </div>
                        
                        <div id="youtube-container" style="display: none;">
                            <div class="form-group">
                                <label for="youtube-url">ğŸ“º YouTube Video URL:</label>
                                <input type="url" id="youtube-url" name="youtube_url" 
                                       placeholder="https://www.youtube.com/watch?v=..." 
                                       pattern="https?://(?:www\.)?(?:youtube\.com|youtu\.be)/.*"
                                       title="Please enter a valid YouTube URL">
                                <div class="form-help">Paste a YouTube video URL for your comment</div>
                            </div>
                            <div id="youtube-preview" style="display: none;">
                                <div class="youtube-video-container">
                                    <iframe id="youtube-embed" width="300" height="200" 
                                            frameborder="0" allowfullscreen 
                                            style="border-radius: 8px; margin-top: 10px;"></iframe>
                                </div>
                                <button type="button" id="change-youtube" class="btn btn-sm btn-outline" style="margin-top: 10px;">Change YouTube URL</button>
                            </div>
                        </div>
                    </div>
                        
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success" onclick="return validateCommentForm()" title="ğŸ’¬ Add Comment">ğŸ’¬ Add Comment</button>
                    </div>
                </form>
            </div>
        {% else %}
            <p><a href="{% url 'exercises:login' %}" title="ğŸ”‘ Login to add comments">ğŸ”‘ Login to add comments</a></p>
        {% endif %}
    </div>
</div>

<script>
// Simplified video recording functionality for comments
document.addEventListener('DOMContentLoaded', function() {
    const uploadBtn = document.getElementById('upload-btn');
    const recordBtn = document.getElementById('record-btn');
    const youtubeBtn = document.getElementById('youtube-btn');
    let videoInput = document.querySelector('input[name="video"]');
    const youtubeContainer = document.getElementById('youtube-container');
    const youtubeUrlInput = document.getElementById('youtube-url');
    const youtubePreview = document.getElementById('youtube-preview');
    const youtubeEmbed = document.getElementById('youtube-embed');
    const changeYoutubeBtn = document.getElementById('change-youtube');
    const videoPreview = document.getElementById('video-preview');
    const videoName = document.getElementById('video-name');
    const webcamContainer = document.getElementById('webcam-container');
    const startCameraBtn = document.getElementById('start-camera');
    const recordVideoBtn = document.getElementById('record-video');
    const stopBtn = document.getElementById('stop-recording');
    const webcamPreview = document.getElementById('webcam-preview');
    const recordingStatus = document.getElementById('recording-status');
    const recordingTime = document.getElementById('recording-time');
    const commentVideoPlayback = document.getElementById('comment-video-playback');
    const commentChangeVideoBtn = document.getElementById('comment-change-video');
    
    if (!startCameraBtn) return; // Exit if not on comment form
    
    let mediaRecorder;
    let recordedChunks = [];
    let recordingStartTime;
    let recordingInterval;
    let currentStream = null;
    let currentFacingMode = 'user'; // Start with front camera
    
    // Upload button click
    uploadBtn.addEventListener('click', function() {
        videoInput.click();
        youtubeContainer.style.display = 'none';
        webcamContainer.style.display = 'none';
    });
    
    // YouTube button click
    youtubeBtn.addEventListener('click', function() {
        youtubeContainer.style.display = 'block';
        videoPreview.style.display = 'none';
        webcamContainer.style.display = 'none';
        youtubePreview.style.display = 'none';
        youtubeUrlInput.value = '';
    });

    // Change recorded/uploaded video
    commentChangeVideoBtn.addEventListener('click', function() {
        videoPreview.style.display = 'none';
        videoInput.value = '';
        // Clear recorded video reference
        window.recordedVideoFile = null;
        if (commentVideoPlayback) {
            commentVideoPlayback.pause();
            commentVideoPlayback.removeAttribute('src');
            commentVideoPlayback.style.display = 'none';
        }
    });

    // File input change
    videoInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const file = this.files[0];
            videoName.textContent = file.name;
            videoPreview.style.display = 'block';
            webcamContainer.style.display = 'none';
            // Clear recorded video reference when uploading new file
            window.recordedVideoFile = null;
            if (commentVideoPlayback) {
                commentVideoPlayback.src = URL.createObjectURL(file);
                commentVideoPlayback.style.display = 'block';
                commentVideoPlayback.play().catch(() => {});
            }
        }
    });
    
    // Record button click - start camera and recording in one step
    recordBtn.addEventListener('click', async function() {
        webcamContainer.style.display = 'block';
        videoPreview.style.display = 'none';
        youtubeContainer.style.display = 'none';
        
        // Auto-start camera and recording for one-click experience
        try {
            await startCamera();
            // Small delay to ensure camera is ready
            setTimeout(() => {
                if (currentStream) {
                    recordVideoBtn.click();
                }
            }, 500);
        } catch (err) {
            console.error('Auto-start failed:', err);
        }
    });
    
    // YouTube URL input change
    youtubeUrlInput.addEventListener('input', function() {
        const url = this.value.trim();
        if (isValidYouTubeUrl(url)) {
            const videoId = extractYouTubeVideoId(url);
            if (videoId) {
                youtubeEmbed.src = `https://www.youtube.com/embed/${videoId}`;
                youtubePreview.style.display = 'block';
                // Store YouTube URL globally for form submission
                window.youtubeVideoUrl = url;
            }
        } else {
            youtubePreview.style.display = 'none';
            window.youtubeVideoUrl = null;
        }
    });
    
    // Change YouTube URL button
    changeYoutubeBtn.addEventListener('click', function() {
        youtubePreview.style.display = 'none';
        youtubeUrlInput.value = '';
        youtubeUrlInput.focus();
        window.youtubeVideoUrl = null;
    });
    
    // YouTube URL validation function
    function isValidYouTubeUrl(url) {
        const patterns = [
            /^https?:\/\/(?:www\.)?youtube\.com\/watch\?v=[a-zA-Z0-9_-]{11}/,
            /^https?:\/\/youtu\.be\/[a-zA-Z0-9_-]{11}/,
            /^https?:\/\/(?:www\.)?youtube\.com\/embed\/[a-zA-Z0-9_-]{11}/
        ];
        return patterns.some(pattern => pattern.test(url));
    }
    
    // Extract YouTube video ID
    function extractYouTubeVideoId(url) {
        const patterns = [
            /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
            /youtube\.com\/watch\?.*v=([a-zA-Z0-9_-]{11})/
        ];
        
        for (const pattern of patterns) {
            const match = url.match(pattern);
            if (match) {
                return match[1];
            }
        }
        return null;
    }
        webcamContainer.style.display = 'block';
        videoPreview.style.display = 'none';
        
        // Auto-start camera and recording for one-click experience
        try {
            await startCamera();
            // Small delay to ensure camera is ready
            setTimeout(() => {
                if (currentStream) {
                    recordVideoBtn.click();
                }
            }, 500);
        } catch (err) {
            console.error('Auto-start failed:', err);
        }
    });
    
    // Start camera
    startCameraBtn.addEventListener('click', async function() {
        await startCamera();
    });
    
    // Flip camera
    const flipCameraBtn = document.getElementById('flip-camera');
    if (flipCameraBtn) {
        flipCameraBtn.addEventListener('click', async function() {
            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            await startCamera();
        });
    }
    
    // Start camera function
    async function startCamera() {
        try {
            // Stop existing stream
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            
            // Mobile-friendly camera constraints
            const constraints = {
                video: { 
                    width: { ideal: 480, max: 720 },
                    height: { ideal: 360, max: 480 },
                    facingMode: currentFacingMode
                },
                audio: true 
            };
            
            currentStream = await navigator.mediaDevices.getUserMedia(constraints);
            webcamPreview.srcObject = currentStream;
            startCameraBtn.style.display = 'none';
            if (flipCameraBtn) flipCameraBtn.style.display = 'inline-block';
            recordVideoBtn.style.display = 'inline-block';
            console.log('Camera started successfully for comment with facing mode:', currentFacingMode);
        } catch (err) {
            console.error('Camera access error:', err);
            let errorMsg = 'Error accessing camera: ' + err.message;
            if (err.name === 'NotAllowedError') {
                errorMsg += '\n\nPlease allow camera access in your browser settings.';
            } else if (err.name === 'NotFoundError') {
                errorMsg += '\n\nNo camera found. Please check your device.';
            }
            alert(errorMsg);
        }
    }
    
    // Start recording
    recordVideoBtn.addEventListener('click', function() {
        recordedChunks = [];
        const stream = webcamPreview.srcObject;
        
        mediaRecorder = new MediaRecorder(stream);
        
        mediaRecorder.ondataavailable = function(event) {
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        };
        
        mediaRecorder.onstop = function() {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const file = new File([blob], 'webcam-comment.webm', { type: 'video/webm' });
            
            console.log('Recording stopped, blob size:', blob.size, 'bytes');
            
            // Store the recorded file globally for form submission
            window.recordedVideoFile = file;
            
            // Create a more reliable file attachment method
            try {
                // Method 1: Try to create a new FileList using DataTransfer
                if (window.DataTransfer) {
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    videoInput.files = dataTransfer.files;
                    console.log('File attached using DataTransfer API');
                } else {
                    throw new Error('DataTransfer not available');
                }
            } catch (e) {
                console.warn('DataTransfer failed, using fallback method:', e);
                // Fallback: Create a new input element with the file
                const newInput = document.createElement('input');
                newInput.type = 'file';
                newInput.name = 'video';
                newInput.accept = 'video/*';
                newInput.style.display = 'none';
                
                // Try to set the file directly
                try {
                    newInput.files = [file];
                } catch (e2) {
                    console.warn('Direct file assignment failed:', e2);
                    // Last resort: store file reference for manual handling
                    newInput.recordedFile = file;
                }
                
                // Replace the original input
                videoInput.parentNode.replaceChild(newInput, videoInput);
                videoInput = newInput;
                console.log('File attached using fallback method');
            }
            
            // Show success and preview
            videoName.textContent = 'Webcam Recording (' + Math.round(file.size / 1024) + ' KB)';
            videoPreview.style.display = 'block';
            
            if (commentVideoPlayback) {
                commentVideoPlayback.src = URL.createObjectURL(blob);
                commentVideoPlayback.style.display = 'block';
                commentVideoPlayback.load(); // Force reload
                commentVideoPlayback.play().catch((err) => {
                    console.log('Auto-play prevented:', err);
                });
            }
            
            webcamContainer.style.display = 'none';
            
            console.log('Comment video recorded successfully, file size:', file.size, 'bytes');
            console.log('Video input files:', videoInput.files);
        };
        
        mediaRecorder.start();
        recordVideoBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
        recordingStatus.style.display = 'block';
        
        recordingStartTime = Date.now();
        recordingInterval = setInterval(updateRecordingTime, 1000);
    });
    
    // Stop recording
    stopBtn.addEventListener('click', function() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
        }
        
        stopBtn.style.display = 'none';
        recordVideoBtn.style.display = 'inline-block';
        recordingStatus.style.display = 'none';
        clearInterval(recordingInterval);
    });
    
    // Update recording time
    function updateRecordingTime() {
        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        recordingTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // Form validation for comments
    function validateCommentForm() {
        const text = document.getElementById('comment-text').value.trim();
        
        // Check for video file in input, recorded video, or YouTube URL
        const hasVideoFile = (videoInput.files && videoInput.files.length > 0) || window.recordedVideoFile;
        const hasYouTubeUrl = window.youtubeVideoUrl;
        
        if (!hasVideoFile && !hasYouTubeUrl) {
            alert('Either a video file or YouTube URL is required for comments.');
            return false;
        }
        
        if (hasVideoFile && hasYouTubeUrl) {
            alert('Please provide either a video file or YouTube URL, not both.');
            return false;
        }
        
        // Ensure recorded video is properly attached to form
        if (window.recordedVideoFile && (!videoInput.files || videoInput.files.length === 0)) {
            console.log('Attaching recorded video to form...');
            try {
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(window.recordedVideoFile);
                videoInput.files = dataTransfer.files;
                console.log('Recorded video attached to form');
            } catch (e) {
                console.error('Failed to attach recorded video:', e);
                alert('Error attaching recorded video. Please try recording again.');
                return false;
            }
        }
        
        if (videoInput.files && videoInput.files.length > 0) {
            const file = videoInput.files[0];
            if (file.size === 0) {
                alert('The video file appears to be empty. Please try recording again.');
                return false;
            }
            console.log('Comment form validation passed, submitting comment with video:', file.name, file.size, 'bytes');
        }
        
        return true;
    }
    
    // Add form submission handler to ensure recorded video is included
    const commentForm = document.querySelector('form[action*="add_comment"]');
    if (commentForm) {
        commentForm.addEventListener('submit', function(e) {
            // Ensure recorded video is attached before submission
            if (window.recordedVideoFile && (!videoInput.files || videoInput.files.length === 0)) {
                console.log('Form submission: attaching recorded video...');
                try {
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(window.recordedVideoFile);
                    videoInput.files = dataTransfer.files;
                    console.log('Recorded video attached during form submission');
                } catch (error) {
                    console.error('Failed to attach recorded video during submission:', error);
                    e.preventDefault();
                    alert('Error attaching recorded video. Please try recording again.');
                    return false;
                }
            }
            
            // Verify video is present before allowing submission
            const hasVideoFile = (videoInput.files && videoInput.files.length > 0) || window.recordedVideoFile;
            const hasYouTubeUrl = window.youtubeVideoUrl;
            
            if (!hasVideoFile && !hasYouTubeUrl) {
                e.preventDefault();
                alert('Either a video file or YouTube URL is required for comments.');
                return false;
            }
            
            if (hasVideoFile && hasYouTubeUrl) {
                e.preventDefault();
                alert('Please provide either a video file or YouTube URL, not both.');
                return false;
            }
            
            console.log('Form submitting with video file:', videoInput.files[0].name, videoInput.files[0].size, 'bytes');
        });
    }
});
</script>
{% endblock %}
