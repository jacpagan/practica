{% extends 'exercises/base.html' %}

{% block title %}{{ exercise.name }} - Practika{% endblock %}

{% block content %}
<div class="card">
    <h2>{{ exercise.name }}</h2>
    {% if exercise.description %}
        <p>{{ exercise.description }}</p>
    {% endif %}
    
    <div class="meta">
        <p><strong>Created by:</strong> {{ exercise.created_by.username }}</p>
        <p><strong>Created:</strong> {{ exercise.created_at|date:"M d, Y H:i" }}</p>
        <p><strong>Last updated:</strong> {{ exercise.updated_at|date:"M d, Y H:i" }}</p>
    </div>
    
    <div class="video-container">
        <h3>Exercise Video</h3>
        <video class="video-player" controls>
            <source src="{{ exercise.video_asset.get_public_url }}" type="{{ exercise.video_asset.mime_type }}">
            Your browser does not support the video tag.
        </video>
    </div>

    <div class="comments-section">
        <h3>Video Comments ({{ exercise.videocomment_set.count }})</h3>
        
        {% for comment in exercise.videocomment_set.all %}
        <div class="comment">
            <div class="meta">
                <strong>{{ comment.author.username }}</strong>
                {% if comment.author.is_staff %}<span class="admin-badge">Admin</span>{% endif %}
                <span>{{ comment.created_at|date:"M d, Y H:i" }}</span>
                
                {% if user == comment.author or user.is_staff %}
                <div class="comment-actions">
                    <a href="{% url 'comments:edit_comment' comment.id %}" class="btn btn-sm btn-warning">Edit</a>
                    <a href="{% url 'comments:delete_comment' comment.id %}" class="btn btn-sm btn-danger" 
                       onclick="return confirm('Are you sure you want to delete this comment?')">Delete</a>
                </div>
                {% endif %}
            </div>
            
            {% if comment.text %}
                <p>{{ comment.text }}</p>
            {% endif %}
        </div>
        {% empty %}
            <p>No comments yet. Be the first to comment!</p>
        {% endfor %}
        
        {% if user.is_authenticated %}
            <div class="card">
                <h4>Add Comment</h4>
                <form method="post" action="{% url 'comments:add_comment' exercise.id %}" enctype="multipart/form-data">
                    <!-- CSRF token temporarily disabled for testing -->
                    <div class="form-group">
                        <label for="comment-text">Comment Text:</label>
                        <textarea id="comment-text" name="text" rows="3" placeholder="Write your comment here..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Video Comment (Optional):</label>
                        <div class="video-input-options">
                            <div class="option-tabs">
                                <button type="button" class="tab-btn active" data-tab="upload">Upload Video File</button>
                                <button type="button" class="tab-btn" data-tab="record">Record with Webcam</button>
                            </div>
                            
                            <div class="tab-content active" id="upload-tab">
                                <input type="file" name="video" accept="video/*">
                                <p class="form-help">Upload a video file (MP4, AVI, MOV, WebM, or OGG)</p>
                            </div>
                            
                            <div class="tab-content" id="record-tab">
                                <div class="webcam-container">
                                    <video id="webcam-preview" autoplay muted></video>
                                    <canvas id="webcam-canvas" style="display: none;"></canvas>
                                    <div class="webcam-controls">
                                        <button type="button" id="start-camera" class="btn btn-primary">Start Camera</button>
                                        <button type="button" id="record-video" class="btn btn-danger" style="display: none;">Record</button>
                                        <button type="button" id="stop-recording" class="btn btn-warning" style="display: none;">Stop Recording</button>
                                    </div>
                                    <div id="recording-status" style="display: none;">
                                        <p>Recording... <span id="recording-time">00:00</span></p>
                                    </div>
                                </div>
                                <input type="hidden" id="recorded-video" name="recorded_video">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">Add Comment</button>
                    </div>
                </form>
            </div>
        {% else %}
            <p><a href="{% url 'exercises:login' %}">Login to add comments</a></p>
        {% endif %}
    </div>
</div>

<script>
// Webcam recording functionality for comments
document.addEventListener('DOMContentLoaded', function() {
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    const startCameraBtn = document.getElementById('start-camera');
    const recordBtn = document.getElementById('record-video');
    const stopBtn = document.getElementById('stop-recording');
    const webcamPreview = document.getElementById('webcam-preview');
    const canvas = document.getElementById('webcam-canvas');
    const recordingStatus = document.getElementById('recording-status');
    const recordingTime = document.getElementById('recording-time');
    const recordedVideoInput = document.getElementById('recorded-video');
    
    if (!startCameraBtn) return; // Exit if not on comment form
    
    let mediaRecorder;
    let recordedChunks = [];
    let recordingStartTime;
    let recordingInterval;
    
    // Tab switching
    tabBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const tabName = this.dataset.tab;
            
            // Update active tab button
            tabBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Update active tab content
            tabBtns.forEach(content => {
                content.classList.remove('active');
                if (content.id === tabName + '-tab') {
                    content.classList.add('active');
                }
            });
        });
    });
    
    // Start camera
    startCameraBtn.addEventListener('click', async function() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: true, 
                audio: true 
            });
            webcamPreview.srcObject = stream;
            startCameraBtn.style.display = 'none';
            recordBtn.style.display = 'inline-block';
        } catch (err) {
            alert('Error accessing camera: ' + err.message);
        }
    });
    
    // Start recording
    recordBtn.addEventListener('click', function() {
        recordedChunks = [];
        const stream = webcamPreview.srcObject;
        
        mediaRecorder = new MediaRecorder(stream);
        
        mediaRecorder.ondataavailable = function(event) {
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        };
        
        mediaRecorder.onstop = function() {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            
            // Create a file input for the recorded video
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.name = 'video';
            fileInput.style.display = 'none';
            fileInput.files = new DataTransfer().files;
            
            // Replace the file input
            const originalFileInput = document.querySelector('input[name="video"]');
            if (originalFileInput) {
                originalFileInput.parentNode.replaceChild(fileInput, originalFileInput);
            }
            
            // Set the recorded video data
            recordedVideoInput.value = url;
            
            // Show success message
            alert('Video recorded successfully! You can now submit your comment.');
        };
        
        mediaRecorder.start();
        recordBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
        recordingStatus.style.display = 'block';
        
        // Start recording timer
        recordingStartTime = Date.now();
        recordingInterval = setInterval(updateRecordingTime, 1000);
    });
    
    // Stop recording
    stopBtn.addEventListener('click', function() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
        }
        
        stopBtn.style.display = 'none';
        recordBtn.style.display = 'inline-block';
        recordingStatus.style.display = 'none';
        
        // Stop timer
        clearInterval(recordingInterval);
    });
    
    // Update recording time
    function updateRecordingTime() {
        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        recordingTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
});
</script>
{% endblock %}
