{% extends 'exercises/base.html' %}

{% block title %}{{ exercise.name }} - Practika{% endblock %}

{% block content %}
<div class="card">
    <h2>{{ exercise.name }}</h2>
    {% if exercise.description %}
        <p>{{ exercise.description }}</p>
    {% endif %}
    
    <div class="meta">
        <p><strong>Created by:</strong> {{ exercise.created_by.username }}</p>
        <p><strong>Created:</strong> {{ exercise.created_at|date:"M d, Y H:i" }}</p>
        <p><strong>Last updated:</strong> {{ exercise.updated_at|date:"M d, Y H:i" }}</p>
    </div>
    
    <div class="video-container">
        <h3>Exercise Video</h3>
        <video class="video-player" controls>
            <source src="{{ exercise.video_asset.get_public_url }}" type="{{ exercise.video_asset.mime_type }}">
            Your browser does not support the video tag.
        </video>
    </div>

    <div class="comments-section">
        <h3>Video Comments ({{ exercise.videocomment_set.count }})</h3>
        
        {% for comment in exercise.videocomment_set.all %}
        <div class="comment">
            <div class="meta">
                <strong>{{ comment.author.username }}</strong>
                {% if comment.author.is_staff %}<span class="admin-badge">Admin</span>{% endif %}
                <span>{{ comment.created_at|date:"M d, Y H:i" }}</span>
                
                {% if user == comment.author or user.is_staff %}
                <div class="comment-actions">
                    <a href="{% url 'comments:edit_comment' comment.id %}" class="btn btn-sm btn-warning">Edit</a>
                    <a href="{% url 'comments:delete_comment' comment.id %}" class="btn btn-sm btn-danger" 
                       onclick="return confirm('Are you sure you want to delete this comment?')">Delete</a>
                </div>
                {% endif %}
            </div>
            
            {% if comment.text %}
                <p>{{ comment.text }}</p>
            {% endif %}
        </div>
        {% empty %}
            <p>No comments yet. Be the first to comment!</p>
        {% endfor %}
        
        {% if user.is_authenticated %}
            <div class="card">
                <h4>Add Comment</h4>
                <form method="post" action="{% url 'comments:add_comment' exercise.id %}">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="comment-text">Comment Text:</label>
                        <textarea id="comment-text" name="text" rows="3" placeholder="Write your comment here..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">Add Comment</button>
                    </div>
                </form>
            </div>
        {% else %}
            <p><a href="{% url 'exercises:login' %}">Login to add comments</a></p>
        {% endif %}
    </div>
</div>

<script>
    // Initialize main video recorder
    document.addEventListener('DOMContentLoaded', function() {
        if (document.getElementById('recorder-container-main')) {
            // Define VideoRecorder class if not already defined
            if (typeof VideoRecorder === 'undefined') {
                class VideoRecorder {
                    constructor(containerId) {
                        this.container = document.getElementById(containerId);
                        this.videoBlob = null;
                        this.mediaRecorder = null;
                        this.stream = null;
                        this.recordedChunks = [];
                    }
                    
                    startRecording() {
                        // Basic implementation for comment recording
                        alert('Video recording functionality not available on this page. Please use the create exercise page for full recording features.');
                    }
                    
                    stopRecording() {
                        // Basic implementation
                    }
                    
                    reset() {
                        // Basic implementation
                    }
                }
            }
            
            window.videoRecorders = window.videoRecorders || {};
            window.videoRecorders['main'] = new VideoRecorder('recorder-container-main');
        }
    });

    // Update comment progress dots
    function updateCommentDot(dotNumber, state) {
        const dot = document.getElementById(`comment-dot-${dotNumber}`);
        if (dot) {
            dot.className = `status-dot ${state}`;
            dot.setAttribute('data-state', state);
        }
    }

    // Submit comment function
    function submitComment() {
        const text = document.getElementById('comment-text').value;
        const videoFile = document.getElementById('video-file').files[0];
        
        if (!videoFile) {
            alert('Please select a video file.');
            return;
        }
        
        // Show progress
        document.getElementById('comment-progress-main').style.display = 'block';
        
        // Create form data
        const formData = new FormData();
        formData.append('text', text);
        formData.append('video', videoFile);
        formData.append('exercise', '{{ exercise.id }}');
        
        // Submit comment
        fetch('/comments/api/comments/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error submitting comment: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error submitting comment. Please try again.');
        });
    }
</script>
{% endblock %}
