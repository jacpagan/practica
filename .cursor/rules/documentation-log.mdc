---
description: Prevent bash PS2 hangs (dquote>, quote>, bquote>) via QuoteGuard
globs:
  - "**/*"
alwaysApply: true

# Instruct Cursor how to format and validate shell commands it emits.
message: |
  ## QuoteGuard — Shell Command Hygiene

  When producing *any* shell/terminal block (bash/sh/zsh):

  1) **Single-line by default.** Do not split a command across lines unless using a deliberate heredoc.

  2) **Balanced quoting check (pre-emit):**
     - Ensure an even count of unescaped `"` outside single quotes.
     - Ensure an even count of unescaped `'` outside double quotes.
     - For backticks and command subs: ensure every `` ` `` has a closing `` ` ``, and every `$(` has a matching `)`.
     - Disallow trailing `\`, lone pipe (`|`), `&&`, `||`, or unmatched `(`, `{`, `[` at EOL.

  3) **Safe multi-line only via heredoc (literal):**
     - Use: `cat <<'EOF' > file.ext` … `EOF`  (delimiter **single-quoted** to disable expansion).
     - Never use unterminated heredocs. Always close with the exact delimiter on its own line.

  4) **Prefer `printf` to `echo` for literals.**
     - `printf '%s\n' 'literal text'` instead of `echo "..."`.
     - For JSON and curl bodies, wrap outer shell with single quotes and inner JSON with double quotes, or use a heredoc.

  5) **Markdown code fences:**
     - Always start with ```bash and end with a closing ``` on its own line.
     - Do not include prompts like `$ `; emit raw commands for copy/paste safety.

  6) **If captured output shows a PS2 continuation prompt (`dquote>`, `quote>`, or `bquote>`):**
     - **Immediately** suggest recovery steps (no further commands until recovered):
       - `# press Ctrl-C to abort the unterminated command`
       - `stty sane; reset || true; clear || true`
       - Then re-emit a **sanitized** single-line version of the last command with balanced quoting (apply Rules 2–5).

  7) **Examples (GOOD ⇢ BAD):**
     - GOOD: `sed -n '1,20p' /var/log/syslog`
       BAD:  `sed -n "1,20p /var/log/syslog`              # unclosed "
     - GOOD: `printf '%s\n' '{"name":"pr"}' > cfg.json`
       BAD:  `echo "{"name":"pr"}" > cfg.json`            # quote nesting
     - GOOD:
         cat <<'EOF' > script.sh
         #!/usr/bin/env bash
         set -euo pipefail
         echo "ok"
         EOF
       BAD:
         cat <<EOF > script.sh
         echo "$UNSET_VAR
         # (missing EOF; expands vars)

  8) **Final preflight before emitting any shell block:**
     - If any check fails, **rewrite** to a single-line or heredoc-safe form; do not emit a block that could yield PS2.

