name: Documentation Pipeline - Enterprise SDLC

on:
  push:
    paths: ['docs/**']
    branches: [main, develop]
  pull_request:
    paths: ['docs/**']
    branches: [main, develop]

jobs:
  validate:
    name: Validate Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install markdown lint
        run: npm install -g markdownlint-cli
        
      - name: Validate markdown syntax
        run: markdownlint docs/**/*.md
        
      - name: Check for broken links
        run: |
          npm install -g markdown-link-check
          find docs -name "*.md" -exec markdown-link-check {} \;

  convert:
    name: Convert Documentation
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc
          pip install boto3 tabulate
          
      - name: Convert markdown to HTML
        run: |
          cd docs-site
          chmod +x convert-markdown.sh
          ./convert-markdown.sh
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: documentation-site
          path: docs-site/*.html
          retention-days: 30

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: convert
    if: github.ref == 'refs/heads/develop'
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: documentation-site
          path: docs-site/
          
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
          
      - name: Deploy to staging
        run: |
          cd docs-site
          chmod +x deploy.sh
          echo "staging.docs.jpagan.com" | ./deploy.sh

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: convert
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: documentation-site
          path: docs-site/
          
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
          
      - name: Deploy to production
        run: |
          cd docs-site
          chmod +x deploy.sh
          echo "docs.jpagan.com" | ./deploy.sh
          
      - name: Notify deployment
        run: |
          echo "Documentation deployed to production: https://docs.jpagan.com"
          echo "Deployment completed at $(date)"

  monitor:
    name: Monitor Deployment
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()
    steps:
      - name: Check site health
        run: |
          # Add health checks for the deployed site
          curl -f https://docs.jpagan.com || echo "Site health check failed"
          
      - name: Performance check
        run: |
          # Add performance monitoring
          echo "Performance monitoring completed"
