name: Infrastructure - Plan and Apply

on:
  push:
    branches: [ main ]
    paths:
      - 'infra/**'
      - 'config/envs/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'infra/**'
      - 'config/envs/**'

env:
  AWS_REGION: us-east-1
  TF_VERSION: '1.5.0'

jobs:
  plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Terraform Init
      run: |
        cd infra
        terraform init

    - name: Terraform Format Check
      run: |
        cd infra
        terraform fmt -check -recursive

    - name: Terraform Validate
      run: |
        cd infra
        terraform validate

    - name: Terraform Plan - Dev
      run: |
        cd infra
        terraform workspace select dev || terraform workspace new dev
        terraform plan -var-file="config/envs/dev.tfvars" -out=tfplan-dev
      continue-on-error: true

    - name: Terraform Plan - Prod
      run: |
        cd infra
        terraform workspace select prod || terraform workspace new prod
        terraform plan -var-file="config/envs/prod.tfvars" -out=tfplan-prod
      continue-on-error: true

    - name: Upload Plan Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: terraform-plans
        path: |
          infra/tfplan-dev
          infra/tfplan-prod
        retention-days: 1

  apply-dev:
    name: Apply to Development
    runs-on: ubuntu-latest
    needs: plan
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Download Plan Artifacts
      uses: actions/download-artifact@v4
      with:
        name: terraform-plans
        path: infra/

    - name: Terraform Init
      run: |
        cd infra
        terraform init

    - name: Terraform Apply - Dev
      run: |
        cd infra
        terraform workspace select dev
        terraform apply tfplan-dev
      env:
        TF_VAR_environment: dev

    - name: Notify Slack - Dev Success
      uses: 8398a7/action-slack@v3
      with:
        status: success
        channel: '#devops'
        text: 'âœ… Infrastructure deployed to DEV environment'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      if: always()

  apply-prod:
    name: Apply to Production
    runs-on: ubuntu-latest
    needs: plan
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Download Plan Artifacts
      uses: actions/download-artifact@v4
      with:
        name: terraform-plans
        path: infra/

    - name: Terraform Init
      run: |
        cd infra
        terraform init

    - name: Terraform Apply - Prod
      run: |
        cd infra
        terraform workspace select prod
        terraform apply tfplan-prod
      env:
        TF_VAR_environment: prod

    - name: Notify Slack - Prod Success
      uses: 8398a7/action-slack@v3
      with:
        status: success
        channel: '#devops'
        text: 'ðŸš€ Infrastructure deployed to PROD environment'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      if: always()

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: 'infra/'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Run Checkov
      uses: bridgecrewio/checkov-action@master
      with:
        directory: infra/
        framework: terraform
        output_format: sarif
        output_file_path: checkov-results.sarif

    - name: Upload Checkov scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'checkov-results.sarif'

  cost-estimation:
    name: Cost Estimation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Install Infracost
      uses: infracost/actions/setup@v2
      with:
        version: latest

    - name: Generate Infracost cost estimate
      run: |
        cd infra
        infracost breakdown --path . --format json --out-file /tmp/infracost.json
        infracost comment --path /tmp/infracost.json --repo $GITHUB_REPOSITORY --pull-request $GITHUB_EVENT_NUMBER --github-token $GITHUB_TOKEN
