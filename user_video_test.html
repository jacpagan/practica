<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Video Playback Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .video-item { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; }
        .video-player { width: 100%; max-width: 600px; margin: 10px 0; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé• User Video Upload & Playback Test</h1>
        <p>This test simulates the complete user experience: uploading videos to exercises and playing them back.</p>
        
        <div id="status" class="status info">
            <strong>Status:</strong> Loading videos...
        </div>

        <div id="video-list"></div>

        <div class="video-item">
            <h3>üì§ Test Video Upload</h3>
            <input type="file" id="videoFile" accept="video/*" style="margin: 10px 0;">
            <br>
            <button onclick="uploadVideo()">Upload Exercise Video</button>
            <div id="upload-status"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        
        // Load all videos on page load
        window.onload = function() {
            loadVideos();
        };

        async function loadVideos() {
            const statusDiv = document.getElementById('status');
            const videoListDiv = document.getElementById('video-list');
            
            try {
                statusDiv.innerHTML = '<strong>Status:</strong> Loading videos...';
                
                const response = await fetch(`${API_BASE}/videos/`);
                const videos = await response.json();
                
                if (videos.length === 0) {
                    videoListDiv.innerHTML = '<div class="status info">No videos found. Upload your first exercise video!</div>';
                    statusDiv.innerHTML = '<strong>Status:</strong> No videos found.';
                    return;
                }
                
                videoListDiv.innerHTML = videos.map(video => `
                    <div class="video-item">
                        <h3>${video.title}</h3>
                        <p><strong>Description:</strong> ${video.description}</p>
                        <p><strong>Tags:</strong> ${video.tags}</p>
                        <p><strong>Uploaded:</strong> ${new Date(video.created_at).toLocaleDateString()}</p>
                        <p><strong>Practice Sessions:</strong> ${video.practice_threads.length}</p>
                        
                        <div style="margin: 15px 0;">
                            <button onclick="playVideo('${video.video_file}', '${video.title}')">
                                ‚ñ∂Ô∏è Play Exercise Video
                            </button>
                            <button onclick="showVideoInfo('${video.video_file}')">
                                ‚ÑπÔ∏è Video Info
                            </button>
                        </div>
                        
                        <div id="player-${video.id}" style="display: none;">
                            <video controls class="video-player">
                                <source src="http://localhost:8000${video.video_file}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            <p><strong>Now Playing:</strong> ${video.title}</p>
                        </div>
                        
                        <div id="info-${video.id}" style="display: none;">
                            <p><strong>Video URL:</strong> <code>http://localhost:8000${video.video_file}</code></p>
                            <p><strong>File Type:</strong> ${video.video_file.split('.').pop().toUpperCase()}</p>
                        </div>
                    </div>
                `).join('');
                
                statusDiv.innerHTML = `<strong>Status:</strong> ‚úÖ Found ${videos.length} exercise videos. Users can upload and play them!`;
                
            } catch (error) {
                videoListDiv.innerHTML = `<div class="status error">‚ùå Failed to load videos: ${error.message}</div>`;
                statusDiv.innerHTML = '<strong>Status:</strong> ‚ùå Error loading videos.';
            }
        }

        function playVideo(videoFile, title) {
            // Hide all other players
            document.querySelectorAll('[id^="player-"]').forEach(el => el.style.display = 'none');
            document.querySelectorAll('[id^="info-"]').forEach(el => el.style.display = 'none');
            
            // Show the selected player
            const videoId = videoFile.split('/').pop().split('.')[0];
            const playerDiv = document.getElementById(`player-${videoId}`);
            if (playerDiv) {
                playerDiv.style.display = 'block';
                const video = playerDiv.querySelector('video');
                video.load(); // Reload the video
            }
        }

        function showVideoInfo(videoFile) {
            // Hide all other info
            document.querySelectorAll('[id^="player-"]').forEach(el => el.style.display = 'none');
            document.querySelectorAll('[id^="info-"]').forEach(el => el.style.display = 'none');
            
            // Show the selected info
            const videoId = videoFile.split('/').pop().split('.')[0];
            const infoDiv = document.getElementById(`info-${videoId}`);
            if (infoDiv) {
                infoDiv.style.display = 'block';
            }
        }

        async function uploadVideo() {
            const fileInput = document.getElementById('videoFile');
            const statusDiv = document.getElementById('upload-status');
            
            if (!fileInput.files[0]) {
                statusDiv.innerHTML = '<div class="status error">Please select a video file first.</div>';
                return;
            }

            const formData = new FormData();
            formData.append('title', 'User Test Video');
            formData.append('description', 'Testing user upload and playback workflow');
            formData.append('tags', 'user-test,upload,playback');
            formData.append('video_file', fileInput.files[0]);

            try {
                statusDiv.innerHTML = '<div class="status info">Uploading video...</div>';
                
                const response = await fetch(`${API_BASE}/videos/upload/`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    statusDiv.innerHTML = `
                        <div class="status success">
                            ‚úÖ Video uploaded successfully!<br>
                            <strong>Video ID:</strong> ${data.id}<br>
                            <strong>File:</strong> ${data.video_file}
                        </div>
                    `;
                    loadVideos(); // Refresh the list
                } else {
                    statusDiv.innerHTML = `<div class="status error">‚ùå Upload failed. Status: ${response.status}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå Upload error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
