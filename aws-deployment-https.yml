AWSTemplateFormatVersion: '2010-09-09'
Description: 'Practika Django App - HTTPS Load Balancer Setup'

Parameters:
  DBPassword:
    Type: String
    NoEcho: true
    Description: 'Database admin password'
    MinLength: 8

Resources:
  # Application Load Balancer with HTTPS
  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: practika-https-alb
      Scheme: internet-facing
      Type: application
      Subnets:
        - subnet-010164e837165195b
        - subnet-02db180bb6cf6f85d
      SecurityGroups:
        - !Ref ALBSecurityGroup

  # ALB Security Group
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for HTTPS ALB
      VpcId: vpc-0a39483b4e3bf752b
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0

  # ALB Target Group
  ALBTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: practika-https-target-group
      Port: 8000
      Protocol: HTTP
      VpcId: vpc-0a39483b4e3bf752b
      TargetType: ip
      HealthCheckPath: /core/health/
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3

  # HTTPS Listener
  HTTPSListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 443
      Protocol: HTTPS
      SslPolicy: ELBSecurityPolicy-TLS-1-2-2017-01
      Certificates:
        - CertificateArn: arn:aws:acm:us-east-1:164782963509:certificate/38e1452f-2da3-4a76-844f-d906b7b2bf28
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref ALBTargetGroup

  # HTTP to HTTPS Redirect Listener
  HTTPListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: redirect
          RedirectConfig:
            Protocol: HTTPS
            Port: '443'
            StatusCode: HTTP_301

  # ECS Task Definition
  TaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: practika-https-task
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      Cpu: 256
      Memory: 512
      ExecutionRoleArn: !GetAtt ECSTaskExecutionRole.Arn
      TaskRoleArn: !GetAtt ECSTaskRole.Arn
      ContainerDefinitions:
        - Name: practika-web
          Image: 164782963509.dkr.ecr.us-east-1.amazonaws.com/practika:latest
          PortMappings:
            - ContainerPort: 8000
              Protocol: tcp
          Environment:
            - Name: DJANGO_ENVIRONMENT
              Value: production
            - Name: DJANGO_DEBUG
              Value: 'False'
            - Name: DJANGO_ALLOWED_HOSTS
              Value: '*'
            - Name: DJANGO_SECRET_KEY
              Value: 'django-insecure-practika-dogfooding-key-change-in-production'
            - Name: DATABASE_URL
              Value: !Sub 'postgresql://practika_admin:${DBPassword}@practika-db.cwn404is0bz8.us-east-1.rds.amazonaws.com:5432/practika'
            - Name: USE_S3
              Value: 'True'
            - Name: AWS_STORAGE_BUCKET_NAME
              Value: practika-simple-videos
            - Name: AWS_S3_REGION_NAME
              Value: us-east-1

  # ECS Service
  ECSService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: practika-https-service
      Cluster: practika-cluster
      TaskDefinition: !Ref TaskDefinition
      DesiredCount: 1
      CapacityProviderStrategy:
        - CapacityProvider: FARGATE_SPOT
          Weight: 1
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups:
            - !Ref ECSSecurityGroup
          Subnets:
            - subnet-010164e837165195b
            - subnet-02db180bb6cf6f85d
          AssignPublicIp: DISABLED
      LoadBalancers:
        - TargetGroupArn: !Ref ALBTargetGroup
          ContainerName: practika-web
          ContainerPort: 8000

  # ECS Security Group
  ECSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for ECS tasks with HTTPS
      VpcId: vpc-0a39483b4e3bf752b
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8000
          ToPort: 8000
          SourceSecurityGroupId: !Ref ALBSecurityGroup

  # IAM Roles
  ECSTaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy

  ECSTaskRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: practika-task-policy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - 'arn:aws:s3:::practika-simple-videos/*'
                  - 'arn:aws:s3:::practika-simple-videos'

Outputs:
  LoadBalancerDNS:
    Description: HTTPS Load Balancer DNS name
    Value: !GetAtt ApplicationLoadBalancer.DNSName

  LoadBalancerURL:
    Description: HTTPS URL for the application
    Value: !Sub 'https://${ApplicationLoadBalancer.DNSName}'
